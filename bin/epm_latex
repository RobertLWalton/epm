#! /bin/php
<?php

// File:	epm_latex
// Author:	Robert L Walton <walton@acm.org>
// Date:	Mon Oct 12 01:26:52 EDT 2020

// The authors have placed EPM (its files and the
// content of these files) in the public domain;
// they make no warranty and accept no liability
// for EPM.

$document = <<<'EOT'
    epm_latex PPPP

Executes

    pdflatex -record -no-shell-escape -interaction \
             nonstopmode -halt-on-error PPPP.tex \
	     >PPPP.tout 2>PPPP.terr

and scans PPPP.log file for errors, appending any found
to PPPP.terr.  An error in PPPP.log begins with one of
the following:

  (1) a line that has `!' as its first character
  (2) a line that has `at lines DD--DD' at its end,
      where DD denotes any sequence of digits
  (3) a line that contains `while \\output is active'
  (4) a line that begins with `l.<digit>+<whitespace>'
      
An error ends with a blank line.

If there are errors, this program also outputs page
number lines that have the format `[NN]', where NN is
the page number.  Errors generally occur in a page
whose `[NN]' line either is the first preceding or the
first following the error message.

This program returns the exit code of pdflatex as its
exit code.

EOT;

if ( $argc < 2 || preg_match ( '/^-doc/', $argv[1] ) )
{
    echo $document;
    exit ( 0 );
}

$PPPP = $argv[1];

$command = "pdflatex -record -no-shell-escape"
         . " -interaction nonstopmode"
	 . " -halt-on-error $PPPP.tex"
	 . " >$PPPP.tout 2>$PPPP.terr";

exec ( $command, $discard, $code );

$LOG = "$PPPP.log";
$ERR = "$PPPP.terr";
$c = @file_get_contents ( $LOG  );
if ( $c === false )
{
    file_put_contents
        ( $ERR, "cannot read $LOG", FILE_APPEND );
    exit ( $code );
}

$in_error = false;
$out = '';
$errors = 0;
foreach ( explode ( "\n", $c ) as $line )
{
    $line = rtrim ( $line );
    if ( $line == '' )
    {
        if ( $in_error )
	{
	    $in_error = false;
	    $out .= PHP_EOL;
	}
    }
    elseif ( ! $in_error && $line[0] == '!' )
    {
	$in_error = true;
	$out .= $line . PHP_EOL;
	++ $errors;
    }
    elseif ( ! $in_error
             &&
	     preg_match
	         ( '/at lines \d+\-\-\d+$/', $line ) )
    {
	$in_error = true;
	$out .= $line . PHP_EOL;
	++ $errors;
    }
    elseif ( ! $in_error
             &&
	     preg_match
	         ( '/while \\\\output is active/',
		   $line ) )
    {
	$in_error = true;
	$out .= $line . PHP_EOL;
	++ $errors;
    }
    elseif ( ! $in_error
             &&
	     preg_match
	         ( '/^l\.\d+\s/', $line ) )
    {
	$in_error = true;
	$out .= $line . PHP_EOL;
	++ $errors;
    }
    elseif ( $in_error )
	$out .= $line . PHP_EOL;
    elseif ( preg_match ( '/\[(\d+)($|\D)/',
                          $line, $matches ) )
	$out .= "[{$matches[1]}]" . PHP_EOL;
}

if ( $errors == 0 && $code != 0 )
    $out = "pdflatex returned $code but no errors found"
         . " in $LOG file" . PHP_EOL;

if ( $errors != 0 )
    file_put_contents ( $ERR, $out, FILE_APPEND );

exit ( $code );
  
?>
