% Educational Problem Manager (EPM) Design Manual.
%
% File:         epm_design.tex
% Author:       Bob Walton (walton@acm.org)
% Date:		See \date below.

% The authors have placed EPM (its files and the
% content of these files) in the public domain; they
% make no warranty and accept no liability for EPM.
  
\documentclass[12pt]{article}

\usepackage[T1]{fontenc}
\usepackage{lmodern}
\usepackage{makeidx}
\usepackage{upquote}

\makeindex

\setlength{\oddsidemargin}{0in}
\setlength{\evensidemargin}{0in}
\setlength{\textwidth}{6.5in}
\setlength{\textheight}{8.5in}
\raggedbottom

\setlength{\unitlength}{1in}

\pagestyle{headings}
\setlength{\parindent}{0.0in}
\setlength{\parskip}{1ex}

\setcounter{secnumdepth}{5}
\setcounter{tocdepth}{5}
\newcommand{\subsubsubsection}[1]{\paragraph[#1]{#1.}}
\newcommand{\subsubsubsubsection}[1]{\subparagraph[#1]{#1.}}

% Begin \tableofcontents surgery.

\newcount\AtCatcode
\AtCatcode=\catcode`@
\catcode `@=11	% @ is now a letter

\renewcommand{\contentsname}{}
\renewcommand\l@section{\@dottedtocline{1}{0.1em}{1.4em}}
\renewcommand\l@table{\@dottedtocline{1}{0.1em}{1.4em}}
\renewcommand\tableofcontents{%
    \begin{list}{}%
	     {\setlength{\itemsep}{0in}%
	      \setlength{\topsep}{0in}%
	      \setlength{\parsep}{1ex}%
	      \setlength{\labelwidth}{0in}%
	      \setlength{\baselineskip}{1.5ex}%
	      \setlength{\leftmargin}{0.8in}%
	      \setlength{\rightmargin}{0.8in}}%
    \item\@starttoc{toc}%
    \end{list}}
\renewcommand\listoftables{%
    \begin{list}{}%
	     {\setlength{\itemsep}{0in}%
	      \setlength{\topsep}{0in}%
	      \setlength{\parsep}{1ex}%
	      \setlength{\labelwidth}{0in}%
	      \setlength{\baselineskip}{1.5ex}%
	      \setlength{\leftmargin}{1.0in}%
	      \setlength{\rightmargin}{1.0in}%
	      }%
    \item\@starttoc{lot}%
    \end{list}}

\catcode `@=\AtCatcode	% @ is now restored

% End \tableofcontents surgery.

\newenvironment{indpar}[1][0.4in]%
	{\begin{list}{}%
		     {\setlength{\itemsep}{0in}%
		      \setlength{\topsep}{0in}%
		      \setlength{\parsep}{1ex}%
		      \setlength{\labelwidth}{#1}%
		      \setlength{\leftmargin}{#1}%
		      \addtolength{\leftmargin}{\labelsep}}%
	 \item}%
	{\end{list}}

\newenvironment{itemlist}[1][0.2in]%
	{\begin{list}{}{\setlength{\labelwidth}{#1}%
		        \setlength{\leftmargin}{\labelwidth}%
		        \addtolength{\leftmargin}{+0.2in}%
		        \addtolength{\linewidth}{-\labelwidth}%
		        \addtolength{\linewidth}{-0.2in}%
		        \renewcommand{\makelabel}[1]{##1\hfill}}
	 \raggedright}%
	{\end{list}}

\newcommand{\TT}[1]{{\tt \bfseries #1}}
\newcommand{\key}[1]{{\bf \em #1}}
\newcommand{\ttkey}[1]{{\tt \bfseries #1}}
\newcommand{\EOL}{\penalty \exhyphenpenalty}
\newcommand{\pagref}[1]{p\pageref{#1}}
\newcommand{\sref}[2]{(\ref{#1}.\ref{#2})}
\newcommand{\FSTACK}[2]{{\tt \bfseries
    #1\begin{tabular}[t]{@{}l@{}}#2\end{tabular}}}
\newcommand{\STACK}[1]{\begin{tabular}[t]{@{}l@{}}
                        #1\end{tabular}}

\newcommand{\ITEM}{\hspace*{-0.2in}}
\newcommand{\TTITEM}[1]{\hspace*{-0.2in}{\TT{#1}}\\}
\newcommand{\BFITEM}[1]{\hspace*{-0.2in}{{\bf #1}}\\}

\newcommand{\STAR}{{\Large $^\star$}}
\newcommand{\PLUS}[1][]{{$^{+#1}$}}
\newcommand{\QMARK}{{$^{\,\mbox{\footnotesize ?}}$}}

\newcommand{\BSL}{\textbackslash}

\begin{document}
        
\title{Educational Problem Manager\\
Design Manual}

\author{Robert L. Walton}

\date{February 25, 2022}
 
\maketitle

\begin{center}
{\large \bf Notice}
\\[2ex]
\begin{minipage}{5.5in}
The authors have placed EPM (its files and the content of these files) in
the public domain; they make no warranty and accept
no liability for EPM.
\end{minipage}
\end{center}
\begin{center}
\large \bf Table of Contents
\end{center}

\bigskip

\tableofcontents 

\newpage

\begin{center}
{\bf Symbol Index}
\\[1ex]
\begin{minipage}{2in}
{\tt H} \dotfill \pagref{H-DIRECTORY} \\
{\tt W} \dotfill \pagref{W-DIRECTORY} \\
{\tt D} \dotfill \pagref{D-DIRECTORY} \\
{\tt ID} \dotfill \pagref{AIDS}
\end{minipage}
\end{center}


\newpage

\section{Introduction}

This document gives design information for EPM system maintainers.
This document supplements but does not reiterate
documentation in the EPM Help Page for
users.  Comments in code files in turn supplement but do not, with
the exception of parameters files,
reiterate this document or the Help Page.

Instructions for setting up an EPM server are in the file
\begin{center}
{\tt include/maintenance\_parameters.php}
\end{center}

\section{Definitions and Rules}

\subsection{Names}\label{NAMES}

\begin{enumerate}
\item \key{User chosen names}\label{USER-CHOSEN-NAME}
consists of letters, digits,
dash({\tt -}), and underscore({\tt \_}), begin with a letter,
and end with a letter or digit.
See {\tt /include/parameters.php} {\tt \$epm\_name\_re}.
\item \key{Visible file names} have basenames that
consist of letters, digits, dash({\tt -}), and
underscore({\tt \_}), begin with a letter or digit, and end
with a letter or digit, and optional extensions that obey
same rules.  See {\tt /include/parameters.php} {\tt \$epm\_filename\_re}.
\item \key{Visible problem file names} have basenames that end with the
      problem name, which may optionally be preceded by a dash({\tt -}) but
      not by any other character.
\item Invisible problem
      file and directory names begin and end with plus({\tt +}).
\item Administrative files may follow other rules.  In particular,
      email addresses have a file with a name that is the URL encoded email
      address, and browser tickets have a file with a name that is the
      32 hex digit ticket itself.
\item \key{User IDs} and \key{team IDs}\label{AIDS} are user chosen names.
      An \key{account ID} is either a user ID or a team ID.
\item \key{E-mail addresses} may \underline{not} have the
      characters {\tt <}, {\tt >}, {\tt "}, {\tt :}, or space
      characters.
\item A \key{login name} is either an e-mail address, or an
      account ID followed by a {\tt :} followed by an e-mail address.
\end{enumerate}

\subsection{Times}

\begin{enumerate}
\item Times are formatted as per {\tt /include/parameters.php}
     which:
     \begin{itemize}
     \item defines {\tt \$epm\_time\_\EOL format}
           (defaults to {\tt "\%FT\%T\%Z"}, which
	    produces times such as {\tt 2020-09-15T07:40:10EDT})
     \item sets the time zone using
           {\tt date\_default\_\EOL timezone\_\EOL set}
     \end{itemize}

\end{enumerate}

\subsection{Account IDs}

\begin{enumerate}
\item \key{Account IDs}
      (AIDs) are user chosen names \sref{NAMES}{USER-CHOSEN-NAME}).
      They are unique to the
      account and used for both external and internal identification.
      Once assigned, they cannot be changed.
\item There are two kinds of AIDs: \key{user UIDs} for individual users,
      and \key{team TIDs} for teams \sref{NAMES}{AIDS}.
\end{enumerate}

\subsection{Random IDs}

\begin{enumerate}
\item A \key{random ID} is a 32 hexadecimal digit number, or equivalently
      a 128-bit number.  Several are generated from /dev/random
      the first time the server is used, and thereafter they
      are generated as a pseudo-random sequence using previously
      generated values to aes-128-cbc encrypt previous values.
      See {\tt /include/epm\_random.php}.
\item Browser TICKETS are random IDs.
\item The \key{\$ID} variable is a random ID used to validate
      both POST and GET requests from pages.
      
      For each tab, and
      sometimes for the view window, the first GET for the tab
      or window generates the first \$ID value for the pages
      that will occupy the tab or window, and also generates
      a random key that is used to generate a sequence
      of \$ID values for the tab or window by encrypting
      each \$ID to generate the next \$ID.  Thereafter each
      request is checked to see if it has the right \$ID value,
      and a new \$ID value is generated for the next tab or
      window contents.

      \$ID values are generated and checked by {\tt /page/index.php}
      which is required by all page .php files
      \sref{TABS-AND-WINDOWS}{SEQUENCE-RULE}.
\end{enumerate}

\subsection{Tabs and Windows}
\label{TABS-AND-WINDOWS}

\begin{enumerate}
\item Transactions that make changes to the server files
are executed in tabs.
The \key{main tab} is for non-problem specific
transactions.  For each account problem there is a
\key{problem tab} for transactions on that problem.

Popup windows are used to display information about server files,
without making any changes.  The \key{help window} displays help and
guide information.  The \key{documents index} and
\key{downloads index} windows display indices of
available documents and downloads.  The \key{auxiliary window}
displays files and other information.  Pages that are loaded into
the auxiliary window by default can be loaded into floating windows
instead (just by holding down an ALT key when launching the window):
each floating window is separarate and specific to its content.

\item Pages are assigned to tabs or windows.  The Login, Logout,
Project, User, Manage, List Edit, and Favorites Edit Pages are assigned
to the main tab;
Problem, Option, and Run Pages are assigned to problem tabs;
the View and Template Pages are assigned to the auxiliary
window; the Documents Page is assigned to the documents index window;
the Downloads Page is assigned to the downloads index window;
and Help and Guide Pages are assigned to the help pop-up
window.

\item \key{Page Rule}\label{PAGE-RULE}
At any given time a tab or window that does POSTs has a current page.
A GET can change the current page.  All
transactions done with POSTs
are checked to be sure their page is the current page for
its the tab or window type.  So, for example,
if you have just done a GET to the Project Page,
you cannot POST to the User Page.  Or if you have
just done a GET to the Option Page with problem=PPPP,
you cannot do a POST to the Problem Page with problem=PPPP.

This rule is checked by {\tt index.php} which is required
at the beginning of all pages in tabs or windows that
access the server state.

\item \key{Sequence Rule}\label{SEQUENCE-RULE}
Transactions within a tab are sequenced, so that
if a transaction is out of sequence the tab becomes
\key{orphaned} and must be closed.
Sequencing prevents two main
tabs from existing at the same time, or two problem tabs
for the same problem existing at the same time.

Transactions in a window that does POSTs are also sequenced.

To initialize a sequence, the
page must set \$epm\_ID\_init before it requires index.php.

Sequencing is done
by random sequence \$IDs that are attached to each page.
The next request must contain the current \$ID else the
tab is orphaned.  For the main tab the Login Page initializes
the tab's \$ID sequence.  For problem tabs the Problem Page
initializes the sequence.

Pages that do no posts set \$epm\_page\_type to
\ttkey{+no-post+} and do no sequencing.  Pages that do
views or downloads set \$epm\_page\_type
to \ttkey{+download+} and do no sequencing.

Other pages
that provide read-only views but do POSTs (e.g., the View Page)
set \$epm\_page\_type to a value unique to the page
(e.g., +view+) and set \$epm\_ID\_init on a GET to initiate sequencing
for the page's POSTs.

The sequence rule is checked by {\tt index.php} which is required
at the beginning of all pages in tabs or windows that
access the server state.

\item \key{Stateless Pages}\label{STATELESS-PAGES}
Pages that do no POSTs are referred to a stateless pages, as
they have no session state of their own (they do use state
variables such as \$aid and \$uid).  These include .php
pages that do no POSTs and also .html pages.
\end{enumerate}

\subsection{Directories}
\label{DIRECTORIES}

\begin{enumerate}
\item There are three main directories:\label{MAIN-DIRECTORIES}

      \key{H, Home Directory}:\label{H-DIRECTORY}  This is the {\tt epm}
      directory which is loaded from {\tt github}.

      \key{W, Web Directory}\label{W-DIRECTORY}:  This is the directory
      named by the EPM server URL.  It contains a symbolic link to
      the {\tt index.php} file that is
      the first file loaded when a user initially
      contacts the EPM server.  In also contains a symbolic link to
      the H/page directory and edited versions of the
      include/parameters.php and include/maintenance\_\EOL parameters.php
      files.

      \key{D, Data Directory}\label{D-DIRECTORY}:  This is the directory
      containing all the mutable data for the EPM server.

\item The following subdirectory of H contains the
      EPM files that are directly visible to web clients:

      \key{H/page}:  Loadable page files.  {\tt W/page} is
      symbolically linked to this directory.

\item The following subdirectories of H contain the
      EPM files that are \underline{not}
      directly visible to web clients:

      \key{H/include}:  Files that can be `{\tt require}'ed by
      loadable page files.

      \key{H/bin}:  Binary executables of programs called by
      loadable pages or used for off-line maintenance.

      \key{H/template}:  Templates used to compute client problem
      files from other client or project files.

      \key{H/downloads}:  Example files that can be downloaded.
      			  Indexed by the Downloads Index Page.

      \key{H/documents}:  Documentation files, including this file.
      			  Indexed by the Documents Index Page.

      \key{H/secure}:  Source code for binary executables involved with
      security.

      \key{H/src}:  Source code for binary executables \underline{not}
      involved with security.

      \key{H/setup}:  Initial contents of D, the data directory,
      during EPM server setup.

\end{enumerate}

\subsection{Page Initialization}
\label{PAGE-INITIALIZATION}

\begin{enumerate}
\item The web directory, W \sref{DIRECTORIES}{MAIN-DIRECTORIES},
     contains the following:\label{W-CONTENTS}

  \hspace*{0.2in}\begin{tabular}{l}
      symbolic link {\tt W/page} $\longrightarrow$ {\tt H/page} \\
      symbolic link {\tt W/index.php}
          $\longrightarrow$ {\tt page/index.php} \\
      {\tt W/parameters.php}, edited copy of {\tt H/include/parameters.php} \\
      {\tt W/maintenance\_parameters.php}, \\
      \hspace*{0.2in}edited copy of
           {\tt H/include/maintenance\_parameters.php}, \\
      \hspace*{0.2in}(only used off-line) \\
      \end{tabular}

\item When loaded, a .php page initializes by executing the following steps:
\begin{itemize}
\item Set {\tt \$epm\_page\_type} to indicate the tab or pop-up window
      or other type.  The possible values are:
      
      {\tt +main+} and {\tt +problem+} for tabs;
      
      {\tt +no-post+} for a pop-up window that does \underline{not}
      POST or download;
      
      {\tt +download+} for pages that download files
      so that {\tt <script>}
      in {\tt /page/\EOL index.php} which implements the help button
      is surpressed (these pages do no POSTing and have
      no buttons).
      
      OTHER for auxiliary pages that POST.  E.g., {\tt +view+}
      for the View Page.

\item If the page is the first loaded in a tab or popup-window that POSTs,
      then it must set {\tt \$epm\_ID\_init} to initialize a new
      \$ID sequence for the tab or popup-window.  Otherwise the page
      leaves {\tt \$epm\_ID\_init} unset.

\item The page requires {\tt /page/index.php} using:

      \hspace*{0.2in}{\tt require \_\_DIR\_\_ . '/index.php'}
      
\end{itemize}

\item \label{INDEX-ACTIONS}
      Upon being required, {\tt /page/index.php} executes the
      following in order:
\begin{itemize}
\item Compute:

      \hspace*{0.2in}\begin{tabular}{ll}
		\tt \$epm\_root = ROOT & (begins with {\tt /}) \\
		\tt \$epm\_self = SELF & (begins with {\tt /}) \\
		\tt \$epm\_web = W \\
		\end{tabular}

       where the page currently being loaded has the URL

       \hspace*{0.2in}{\tt http://HOST/ROOT/SELF}

       {\tt SELF} has the form {\tt /page/...}, or if
       not that, the form {\tt /index.php}, HOST is the
       EPM server host name, and {\tt ROOT} is whatever
       is left over.  Here W is the EPM server web directory
       (\pagref{W-DIRECTORY}) and is

       \hspace*{0.2in}{\tt \$\_SERVER['DOCUMENT\_ROOT'] . ROOT}

\item If {\tt SELF} is either {\tt /index.php} or {\tt /page/index.php},
      re-routes the request to {\tt page/\EOL login.php}.  The
      request must be a 'GET' else it is not accepted.

\item Loads {\tt W/parameters.php} which in turn defines H and D
      \sref{DIRECTORIES}{MAIN-DIRECTORIES}.

\item Starts the session and clears the file status cache.
Sets umask to 07 and Cache-Control header to no-store.

\item Runs the following checks and aborts invalid requests:
\begin{itemize}
\item Checks that the client request is using the same IP
address as was used for login, unless the {\tt \$epm\_check\_ipaddr}
parameter is false.
\item Checks that the session is logged in, unless the page being
loaded is {\tt /page/\EOL login.php} or {\tt /page/user.php}.
\item Uses {\tt EPM\_ABORT} (\pagref{EPM_ABORT}) to check that
no other session has been started after this session using the
same {\tt AID:UID} login name.
\end{itemize}

\item If the session has logged in, defines:
\\[2ex]
\hspace*{0.2in}\begin{minipage}{5in}
\$aid = \$\_SESSION['EPM\_AID'] \\
\$uid = \$SESSION['EPM\_UID'] \\
\$lname = <login name> \\
\$is\_team = \$\_SESSION['EPM\_IS\_TEAM'] \\
\$rw = \begin{tabular}[t]{@{}l@{}}
       true if page is read-write; false if read-only \\
       (see {\tt page/index.php} and {\tt include/epm\_rw.php} for details)
       \end{tabular} \\
\$RW \_BUTTON= \begin{tabular}[t]{@{}p{3.5in}@{}}
       a button to be included in the upper right corner of pages that
       allow the read-write mode of a session to be changed; set to
       \verb/''/
       if not team member login
       \end{tabular}
\end{minipage}

\item Defines functions and error handlers.

\item Except for pages of {\tt +download+} and {\tt +no-post+} type,
      checks for violations of the Page Rule (\pagref{PAGE-RULE})
      and aborts violating requests.

\item Except for pages of {\tt +download+} and {\tt +no-post+} type,
      initializes or checks the \$ID to enforce the
      Sequence Rule (\pagref{SEQUENCE-RULE}), and
      re-routes violating requests
      to the {\tt /page/orphan.html} page to declare
      the tab or window orphaned.

\item Except for pages of {\tt +download+} type and xhttp requests,
      and pages run before login is complete,
      sets up shutdown function that will write statistics
      into {\tt accounts/\EOL AID/\EOL +read-write+} or
      {\tt accounts/\EOL AID/\EOL +read-only+}.
\item Except for pages of {\tt +download+} type and xhttp requests,
      defines {\tt <script>} functions that handle the refresh keys and
      launch popup windows.

\item Note that may parameters and some functions are defined in
      {\tt W/parameters.php}.  See that file.  Also see
      {\tt /page/index.php} for functions it defines and more details
      on the above.


\end{itemize}

\end{enumerate}

\subsection{Locking}

In EPM each request is an independent transaction.  Locking
is needed to keep two requests from interferring with each other.

Some EPM operations consist of multiple requests.  However,
only the last of these requests modifies EPM server state
(that is not in a working subdirectory dedicated to the operation).
So the strategy is to have this last request check whether
other conflicting requests happened during the operation, and
if yes, the last request aborts, does not change EPM state, and produces
an error message.

\begin{enumerate}

\item \key{Session Locking} At the beginning of each request
the PHP {\tt session\_start()} function is called.  This locks
the session file (where session data is stored).  As a consequence,
given two requests to the same session, one must complete before
the other starts.

\item \key{Atomic Files}
Some files are shared between sessions and need to be
read and written atomically, so that they maintain their
format specifications, but need no other locking:
\begin{itemize}
\item {\tt .list} files containing problem lists.  Only one
session can write such a file, but many may read it.
\item {\tt +priv+} files containing privileges.  Its possible
but rare for such a file to be writtable by several sessions if it has
multiple owners, but if these collide, `last-writter-wins' is
an acceptable implementation.  These files can have many readers.
\end{itemize}

\item \key{Tab Uniqueness}
A session is logged into a particular
account.  Each tab has a type, either `main'
or the name of a problem in the session account.
The Sequence Rule \sref{TABS-AND-WINDOWS}{SEQUENCE-RULE}
ensures that there is at most one tab of each type at a given
time.

More specifically, if a second tab of a give type is opened by
the user for the session, the second tab gets a new sequence of
\$ID numbers for the tab type, and when the first tab makes a request, its
now obsolete \$ID number is detected (by {\tt index.php}) and
the tab contents are replaced by the {\tt orphan.php} page which
announces that the tab is \key{orphaned} and should be closed.

A similar thing happens if two windows (not-tabs)
exist whose pages execute POSTs and have the same
\$epm\_page\_type (and consequently are the same .php page).
Although such pages make no changes to
the EPM file system, they do have session state that must be
managed between their original GET and subsequent POSTs.

\item \key{Tab Independence}
The pages in each
tab, for the most part, operate on different data from the pages
in other tabs.  A problem tab operates mostly on its problem
directory in the account, and the `main' tab operates mostly on
everything else.  Therefore, since there is at most one tab of
each type, by Tab Uniqueness, most requests are independent
of each other.

\item \key{Administrative Locking}
Administrative files are those in the {\tt admin} directory tree.
Only the Login Page and User Page access most administrative files.
These pages both begin by getting an exclusive lock on the
{\tt admin} directory using the LOCK function in {\tt parameters.php}.

Administrative files with other or extra considerations are:
\begin{itemize}
\item {\tt admin/teams/TID/+read-write+} files: These are themselves
locked by {\tt page/\EOL index.php} and {\tt include/\EOL epm\_rw.php}.
\item {\tt admin/users/UID/UID.info} files.  These are written
atomically by the User Page and read atomically by the Problem Page
in order to ensure the integrity of their format.
\end{itemize}

\item \key{Read-Write Locking}
For team member logins the {\tt admin/teams/TID/+read-write+}
file is locked at the beginning of a request.  If it is
determined that the account is currently read-only, this file
is unlocked immediately, else it is not unlocked until the end of the
request (even if the request makes the session read-only).

If a read-only request attempts to become read-write, the file
is re-locked and remains locked till the end of the request
(even if the request to become read-write is not successful).

This sequences requests from read-write team logins for the
same team, even if the requests are made by different team
members in different sessions.

\item \key{Project Problem Locking}
A project problem directory is locked using the
LOCK function in {\tt parameters.php}
during a push or pull involving the directory.
For pushing this is an exclusive lock; for pulling it is a shared
lock.

A push or pull can involve several requests:
the first to compile actions and the last to execute them
(there can be a request in between that simply presents
information stored in the session data by the first request).
If the project problem directory changes between requests,
because of a push to the directory by another user, the last
request could cause data inconsistency.  To prevent this
the exclusive LOCK time of the directory is monitored to check if some
other session has exclusively locked the directory between the
first and last requests of an operation.
If so, the last request is aborted with an error message and
does not execute.

\item \key{Local Problem Locking}
When a file is uploaded into a problem or made from another file
in the problem, a background job is executed.
Similarly when a {\tt .run} file is run, the run is a background job.
The local problem directory is not modified by a background job
until the job finished, at which time some files may be saved in
the local problem directory.

If the problem has a parent, a shared lock is
obtained on the parent using LOCK at the start of the background
job, and the LOCK time is checked at the end of the job to be sure
it has not changed.  If it has, a push to the parent was done
during the job, an error is declared for the job,
and the job results are not saved in the problem local directory.


Pulls to a local problem directory can be run in the `main' tab
while a background job is run in the local problem directory in
its problem tab.  To prevent conflict, every time the problem
directory is altered its {\tt +altered+} file is touched.
The modification time of this is checked to detect conflicts
and abort either the execution request for a pull or the
finishing of an otherwise sucessful background job.
Local problem directories can be altered when a background
job keeps files, when the Problem Page deletes files, or when
the Project Page pulls to the local problem.


\end{enumerate}


\subsection{Security}

There are two ways to breach an EPM server:

\begin{itemize}

\item \key{Session Hi-Jacking} ~ The session is identified
by the cookie which is a random number.  To hi-jack a session,
the hacker must intercept the cookie.  A good way to 
protect against this is to get a certificate for the EPM
server so the server uses https.

As alternate protection, the {\tt parameters.php} file
contains a parameter which if set will cause the session
to insist that all requests made to it come from the same
IP address.  This might cause problems for legitimate mobile browsers,
but should prevent session hi-jacking.

\item \key{Illegal Requesting} ~ Since it is easy to get a user
account on an EPM server, a user can try to breach the server by issuing
an illegal request from a legitimate session.  Therefore each
request must be checked to be sure it is legal.  If not,
an exit with 'UNACCEPTABLE HTTP ...' message is executed.

An EPM session is definitely \underline{not} stateless.
Not only is there session state, such as the current
user logged into the session, but there is state in the
EPM server data file system.

The Page Rule \sref{TABS-AND-WINDOWS}{PAGE-RULE}
and Sequence Rule \sref{TABS-AND-WINDOWS}{SEQUENCE-RULE}
work together to ensure that a page POSTed to will be
be the same page loaded by the last GET to the tab or
window doing the POST.  This simplifies request checking.

Request checking is just about checking the request type and
request parameters to ensure that the request is legal given the
current state of the session, server, and page loaded by the
last request for the tab or window.

\end{itemize}

\newpage

\section{Data Files}

for template files see \pagref{JOB-TEMPLATES} and \pagref{TEMPLATE.OPTN}
\\{}
[xxx] means file modification time is read by xxx

\begin{center}
\small
\begin{tabular}{|l|l|l|l|l|l|}
\hline
Name & Format & Description & Creators & Updaters & Readers \\
\hline\hline
\TT{error.log} & lines & error log \pagref{ERROR.LOG}
	& (all) & (all) &  \\ 
\hline
\TT{debug.log} & lines & debugging log \pagref{DEBUG.LOG}
	& (all) & (all) &  \\ 
\hline
\TT{admin} & dir & \STACK{administrative\\files}
	& login & \STACK{login\\user} & \STACK{index\\login\\user} \\ 
\hline
\TT{admin/+blocking+} & lines
        & \STACK{email blocking\\control file \pagref{ADMIN/BLOCKING}}
	& (editor) & (editor ) & login \\ 
\hline
\TT{admin/motd.html} & html
        & \STACK{message\\of the day \pagref{ADMIN/MOTD}}
	& (editor) & (editor ) & login \\ 
\hline
\TT{admin/+lock+} & time
        & \STACK{administrative\\lock file \pagref{ADMIN/LOCK}}
	& (updaters) & \STACK{login\\user} & (updaters) \\ 
\hline
\TT{admin/+random+} & binary
        & \STACK{random number\\data \pagref{ADMIN/RANDOM}}
	& login & \STACK{login\\index} & \STACK{login\\index} \\ 
\hline
\TT{admin/+actions+} & lines &
        \STACK{log of\\administrative\\actions \pagref{ADMIN/XXXX/XID/ACTIONS}}
	& (updaters) & user & view \\ 
\hline
\TT{admin/browser} & dir & \STACK{hold browser\\tickets}
	& login & login & login \\ 
\hline
\TT{admin/browser/TICKET} & 1-line
        & ticket info \pagref{ADMIN/TICKET/TICKET}
	& login & & login \\ 
\hline
\TT{admin/email} & dir & holds email files
	& user & user & \STACK{login\\user} \\ 
\hline
\TT{admin/email/EMAIL} & 1-line
        & email info \pagref{ADMIN/EMAIL/EMAIL}
	& user & \STACK{login\\user} & \STACK{login\\user} \\ 
\hline
\TT{\STACK{admin/users\\admin/teams}}
        & dir & \STACK{holds administrative\\user/team\\directories}
	& user & user & \STACK{user\\login} \\ 
\hline
\TT{\STACK{admin/users/UID\\admin/teams/TID}}
        & dir & \STACK{holds administrative\\account files}
	& user & user & \STACK{user\\login} \\ 
\hline
\STACK{
\FSTACK{admin/}{users/UID/\\UID.login}\\
\FSTACK{admin/}{teams/TID/\\UID.login}}
        & lines
        & \STACK{log of\\logins \pagref{ADMIN/USERS/XID/YID.LOGIN}}
	& (updaters) & \STACK{login\\user} & [index]  \\ 
\hline
\STACK{
\FSTACK{admin/}{users/UID/\\UID.inactive}\\
\FSTACK{admin/}{teams/TID/\\UID.inactive}}
        & lines
	& \STACK{inactive\\.login files \pagref{ADMIN/USERS/XID/YID.INACTIVE}}
	& user & & \\ 
\hline
\end{tabular}
\end{center}

\begin{center}
\small
\begin{tabular}{|l|l|l|l|l|l|}
\hline
Name & Format & Description & Creators & Updaters & Readers \\
\hline\hline
\FSTACK{admin/}{users/UID/\\UID.info} & json
	& user info \pagref{ADMIN/USERS/UID/UID.INFO}
	& user & user & \STACK{user\\problem} \\ 
\hline
\FSTACK{admin/}{teams/TID/\\TID.info} & json
	& team info \pagref{ADMIN/USERS/TID/TID.INFO}
	& user & user & user \\ 
\hline
\STACK{
\FSTACK{admin/}{users/UID/\\+actions+}\\
\FSTACK{admin/}{teams/TID/\\+actions+}}
        & lines
        & \STACK{log of accounts's\\administrative\\
	         actions \pagref{ADMIN/XXXX/XID/ACTIONS}}
	& (updaters) & user & view \\ 
\hline
\FSTACK{admin/}{users/UID/\\manager}
    & 1-line & \STACK{teams that UID\\manages \pagref{ADMIN/USERS/UID/MANAGER}}
    & user & user & user \\ 
\hline
\FSTACK{admin/}{users/UID/\\member}
    & 1-line & \STACK{teams of which\\UID is a
                                    \\member \pagref{ADMIN/USERS/UID/MEMBER}}
    & user & user & user \\ 
\hline
\FSTACK{admi}{n/teams/TID/\\+rw+}
    & UID & \STACK{current\\read-write
                          \\user \pagref{ADMIN/TEAMS/TID/RW}}
    & +main+ & +main+ & \STACK{+main+\\index} \\ 
\hline
\TT{accounts} & dir & \STACK{holds account\\subdirectories}
              & user & user & (all) \\ 
\hline
\TT{accounts/AID} & dir & \STACK{holds account\\subdirectories\\and files}
	& user & \STACK{problem\\project} & (all) \\ 
\hline
\FSTACK{accoun}{ts/AID/\\+actions+}
        & lines & \STACK{log of account\\problem\\related\\actions
	                 \pagref{ACCOUNT-ACTIONS}}
	& (updaters) & \STACK{project\\run\\list\\manage} & view \\ 
\hline
\FSTACK{accoun}{ts/AID/\\+read-write+}
        & lines & \STACK{log of account\\read-write mode\\requests
	          \pagref{ACCOUNTS/AID/READ-WRITE}}
	& index & index & [+main+] \\ 
\hline
\FSTACK{accoun}{ts/AID/\\+read-only+}
        & lines & \STACK{log of account\\read-only mode\\requests
	          \pagref{ACCOUNTS/AID/READ-ONLY}}
	& index & index & [+main+] \\ 
\hline
\FSTACK{accoun}{ts/AID/\\+download-UID+}
        & file & \STACK{file to be\\downloaded
	          \pagref{ACCOUNTS/AID/DOWNLOAD}}
	& manage & - & look \\ 
\hline
\end{tabular}
\end{center}

\begin{center}
\small
\begin{tabular}{|l|l|l|l|l|l|}
\hline
Name & Format & Description & Creators & Updaters & Readers \\
\hline\hline
\FSTACK{accoun}{ts/AID/\\+lists+}
        & dir & \STACK{holds account\\problem lists\\and favorites list}
	& \STACK{favorites\\list\\project\\manage\\view}
	& \STACK{list\\favorites} & (creators) \\ 
\hline
\FSTACK{accoun}{ts/AID/\\+lists+/\\+favorites+}
        & lines & \STACK{list of problem\\lists
	                 \pagref{FAVORITES}}
	& \STACK{favorites\\list\\project\\manage\\view}
	& favorites & (creators) \\
\hline
\FSTACK{accoun}{ts/AID/\\+lists+/\\+actions+}
        & lines & \STACK{log of list related\\actions
	                 \pagref{ACCOUNT-ACTIONS}}
	& (updaters) & list & view \\ 
\hline
\FSTACK{accoun}{ts/AID/\\+lists+/\\NAME.list}
        & lines & problem list \pagref{LIST/NAME.LIST}
	& list & list & \STACK{list\\project\\manage\\view} \\
\hline
\FSTACK{accou}{nts/AID/\\PROBLEM}
        & dir & \STACK{holds account\\problem files}
	& project & \STACK{problem\\project} & \STACK{problem\\project} \\ 
\hline
\FSTACK{accou}{nts/AID/\\PROBLEM/\\+actions+}
        & lines & \STACK{log of problem\\related\\actions
	                 \pagref{ACCOUNT-ACTIONS}}
	& (updaters) & \STACK{project\\run} & view \\ 
\hline
\FSTACK{accou}{nts/AID/\\PROBLEM/\\+altered+}
        & empty & \STACK{alteration\\indicator \pagref{PROBLEM/ALTERED}}
	& (updaters) & \STACK{problem\\run} & [updaters] \\ 
\hline
\FSTACK{accou}{nts/AID/\\PROBLEM/\\+changes+}
        & lines & \STACK{log of changes\\made by pulls
	                 \pagref{PULL-CHANGES}}
	& project & project & \\ 
\hline
\FSTACK{accou}{nts/AID/\\PROBLEM/\\+work+}
        & dir & \STACK{working\\directory\\for jobs
	               \pagref{PROBLEM/WORK}}
	& \STACK{problem\\run}
	& \STACK{problem\\run}
	& \STACK{problem\\run} \\ 
\hline
\FSTACK{accou}{nts/AID/\\PROBLEM/\\+run+}
        & dir & \STACK{working\\directory\\for runs
	               \pagref{PROBLEM/RUN}}
	& run & run & run \\
\hline
\FSTACK{accou}{nts/AID/\\PROBLEM/\\\ldots}
        & various & \STACK{files visible\\to users
                           \pagref{PROBLEM-VISIBLE-FILES}}
	& problem & problem & problem \\
\hline
\end{tabular}
\end{center}

\begin{center}
\small
\begin{tabular}{|l|l|l|l|l|l|}
\hline
Name & Format & Description & Creators & Updaters & Readers \\
\hline\hline
\TT{projects} & dir & \STACK{holds project\\subdirectories}
	      & setup & (super)
	      & (all) \\
\hline
\TT{projects/+priv+} & lines & \STACK{root\\privileges \pagref{PRIV}}
	      & (updaters) & manage
	      & \STACK{project\\problem\\run\\option\\manage\\show} \\ 
\hline
\TT{projects/PROJECT} & dir & \STACK{project\\directory}
	      & \STACK{setup\\(super)} & \STACK{project\\manage}
	      & \STACK{project\\problem\\run\\option\\manage} \\ 
\hline
\FSTACK{projects}{/PROJECT/\\+actions+} & lines
	   & \STACK{log of\\project\\related\\actions
		    \pagref{ACCOUNT-ACTIONS}}
	   & (updaters) & \STACK{project\\run\\manage\\list} & view \\
\hline
\FSTACK{projects}{/PROJECT/\\+priv+} & lines
	   & \STACK{project\\privileges \pagref{PRIV}}
	   & (updaters) & manage
	   & \STACK{project\\problem\\run\\option\\manage\\show} \\ 
\hline
\FSTACK{projects}{/PROJECT/\\PROBLEM} & dir
	   & \STACK{problem\\directory\\in project}
	   & project & project & \STACK{project\\problem\\run\\manage} \\
\hline
\FSTACK{projects}{/PROJECT/\\PROBLEM/\\+actions+} & lines
	   & \STACK{log of\\problem\\related\\actions
		    \pagref{ACCOUNT-ACTIONS}}
	   & (updaters) & \STACK{project\\run\\manage} & view \\
\hline
\FSTACK{projects}{/PROJECT/\\PROBLEM/\\+changes+} & lines
	   & \STACK{log of\\problem\\push\\changes
		    \pagref{PUSH-CHANGES}}
	   & project & project & - \\
\hline
\FSTACK{projects}{/PROJECT/\\PROBLEM/\\+lock+} & lock
	   & \STACK{project\\problem\\lock
		    \pagref{PROJECT/PROBLEM/LOCK}}
	   & (updaters) & \STACK{project\\problem\\run} & (updaters) \\
\hline
\FSTACK{projects}{/PROJECT/\\PROBLEM/\\+priv+} & lines
	   & \STACK{problem\\privileges \pagref{PRIV}}
	   & (updaters) & manage
	   & \STACK{project\\problem\\run\\option\\manage\\show} \\ 
\hline
\end{tabular}
\end{center}

\begin{center}
\small
\begin{tabular}{|l|l|l|l|l|l|}
\hline
Name & Format & Description & Creators & Updaters & Readers \\
\hline\hline
\FSTACK{projects}{/PROJECT/\\PROBLEM/\\+sources+} & dir
	   & \STACK{problem\\sources \pagref{PROBLEM/SOURCES}}
	   & project & project & - \\
\hline
\FSTACK{projects}{/PROJECT/\\PROBLEM/\\+submits+} & dir
	   & \STACK{problem\\submits \pagref{PROBLEM/SUBMITS}}
	   & run & run & - \\
\hline
\FSTACK{projects}{/PROJECT/\\PROBLEM/\\\ldots}
        & various & \STACK{files visible\\to users
                           \pagref{PROJECT-VISIBLE-FILES}}
	& project & project & \STACK{problem\\run} \\
\hline
\FSTACK{projects}{/PROJECT/\\+lists+} & dir
	   & \STACK{project\\published lists}
	   & list & list & \STACK{list\\favorites\\project} \\
\hline
\FSTACK{projects}{/PROJECT/\\+lists+/\\NAME.list} & lines
	   & \STACK{list published\\to project \pagref{LIST/PUBLISHED}}
	   & list & list & \STACK{list\\favorites\\project} \\
\hline
\FSTACK{projects}{/PROJECT/\\+lists+/\\+actions+} & lines
	   & \STACK{log of project\\list publishing\\actions
		    \pagref{ACCOUNT-ACTIONS}}
	   & (updaters) & list & view \\
\hline
\TT{default} & dir & \STACK{holds default\\program\\binaries} & setup &  & \\ 
\hline
\TT{+web-save+} & dir & backup of W & backup & backup & backup \\ 
\hline
\TT{+web+} & link & link to W & setup &  & \\ 
\hline
\hline
\end{tabular}
\\[1ex]
setup is setup function of epm/bin/epm \\
backup is backup function of epm/bin/epm \\
\end{center}

\newpage

\section{Session Variables}

Important: See Global Variables defined by index.php
on \pagref{INDEX-DEFINED-GLOBAL-VARIABLES}.

\begin{center}
\begin{tabular}{|l|l|l|l|l|l|}
\hline
Name & Description & Creators & Updaters & Readers \\
\hline\hline
\TT{EPM\_EMAIL} & \STACK{login email}
                & login & & (all) \\ 
\hline
\TT{EPM\_AID} & account ID & \STACK{login\\user} & & (all) \\ 
\hline
\TT{EPM\_UID} & user ID
              & \STACK{login\\user} & & \STACK{login\\user\\manage} \\ 
\hline
\TT{EPM\_IS\_TEAM} & \STACK{true iff AID\\is team ID}
                   & \STACK{login\\user} & & index \\ 
\hline
\TT{EPM\_PAGE[id\_type]} & \STACK{current\\session\\page}
                 & index & index & index \\ 
\hline
\TT{EPM\_IPADDR} & \STACK{session\\IP address}
                 & login & & \STACK{index\\login\\user} \\ 
\hline
\TT{EPM\_TIME} & \STACK{session\\time}
                 & login & & \STACK{index\\login\\user} \\ 
\hline
\TT{EPM\_ID\_GEN[id\_type]} & \$ID generation
                 & index & index & index  \\ 
\hline
\TT{EPM\_ABORT} & \STACK{session\\abort info}
                 & \STACK{login\\user} & & index \\ 
\hline
\end{tabular}
\\[1ex]
id\_type is \$epm\_page\_type if this is not \\
+problem+, +no-post+, or +download+, \\
or is PROBLEM if \$epm\_page\_type is +problem+
\end{center}

\begin{center}
\begin{tabular}{|l|l|l|l|l|l|}
\hline
Name & Description & Creators & Updaters & Readers \\
\hline\hline
\TT{EPM\_PROJECT} & \STACK{permanent\\data for\\project page}
                & project & project & project \\
\hline
\TT{EPM\_USER} & \STACK{permanent\\data for\\user page}
                & user & user & user \\
\hline
\TT{EPM\_MANAGE} & \STACK{permanent\\data for\\manage page}
                & manage & manage & manage \\
\hline
\TT{EPM\_VIEW} & \STACK{permanent\\data for\\view page}
                & view & view & view \\
\hline
\TT{EPM\_PROBLEM[problem]} & \STACK{permanent\\data for\\problem page}
                & problem & problem & problem \\
\hline
\TT{EPM\_WORK[problem]} & \STACK{data for\\current\\background\\task}
                & problem & problem & problem \\
\hline
\TT{EPM\_RUN[problem]} & \STACK{data for\\current\\background\\run}
                & run & run & run \\
\hline
\end{tabular}
\\[1ex]
`problem' is the problem name of the tab
\end{center}

\newpage

\section{Account Actions}
\label{ACCOUNT-ACTIONS}

Actions are recorded in {\tt +actions+} files.  The following
describes actions affecting {\tt accounts} or {\tt projects}
directory contents.  For actions affecting the {\tt admin}
directory contents, see \pagref{ADMIN/ACTIONS}.

An account {\tt +actions+} file consists of lines of format:
\begin{indpar}
TIME~~AID~~TYPE~~PROJECT~~NAME~~DATA...
\end{indpar}
where
\begin{indpar}
\begin{tabular}[t]{@{\hspace{0.2in}}lp{4.5in}}
TIME & Session time for login (EPM\_TIME) \\
AID & AID of account performing action (EPM\_AID) \\
TYPE & see below \\
PROJECT & project involved in action, or {\tt -} if none \\
NAME & PROBLEM involved in action,
       or LIST involved in action,
       or {\tt -} if none \\
DATA & TYPE-specific data, or empty \\
\end{tabular}
\end{indpar}

The possible TYPEs and their corresponding DATA... fields are:
\begin{indpar}
\begin{tabular}[t]{lll}
submit & BASENAME~~SOLUTION-TIME~~SCORE... \\
push \\
pull \\
create-problem \\
create-list \\
update-list \\
publish-list \\
unpublish-list \\
delete-list \\
update-priv \\
\end{tabular}
\end{indpar}

For a `submit' action, BASENAME.run is the the .run file, BASENAME.rout
is the .rout run output file,
the SOLUTION-TIME is the maximum number of CPU seconds
taken by the solution for any one test case .in file, and the SCORE... is
the submission score (`Completely Correct' or otherwise).

All account actions are appended to the {\tt accounts/AID/+actions+} file.

If a PROJECT is involved in an action, the action is also appended to
the {\tt project/\EOL PROJECT/\EOL +actions+} file.

If both a PROJECT and a PROBLEM are involved in an action,
the action is also appended to
the {\tt project/PROJECT/PROBLEM/+actions+} file,
the {\tt project/PROJECT/+actions+} file,
and the {\tt accounts/\EOL AID/\EOL PROBLEM/\EOL +actions+} file.

If a LIST is involved in an action, the action is also appended to
the {\tt accounts/\EOL AID/\EOL +lists+/\EOL +actions+} file.
For list publishing and unpublishing, the action is also appended to
the {\tt projects/PROJECT/+lists+/\EOL +actions+} and
the {\tt projects/PROJECT/\EOL +actions+} files.

\section{Job Templates}
\label{JOB-TEMPLATES}

Job templates are used to make a file XXXX.dext from a file XXXX.sext.
A job template is a {\tt .tmpl} file in the {\tt H/template} directory
that encodes a PHP array in JSON.

A {\tt .tmpl} file is used to make a source file from a destination
file and has a name of the form:
\begin{center}
\tt BBBBBBBB.SSS:BBBBBBBB.DDD:QQQQQQQQ.tmpl
\end{center}

where \begin{tabular}[t]{lp{4in}}
      \tt BBBBBBBB & is the basename of the source and destination file \\
      \tt .SSS     & is the extension of the source file \\
      \tt .DDD     & is the extension of the destination file and
                     may be empty \\
      \tt QQQQQQQQ & is a qualifier, and may be any text, such as
      		     `{\tt JAVA}', `{\tt JAVA-UPLOAD}',
		     `{\tt SUBMIT}', etc. \\
      \end{tabular}

Some examples are:
\begin{indpar}
\begin{itemlist}
\item[\tt PPPP.cc:PPPP:.tmpl] ~ \\
make PPPP binary from PPPP.cc C++ source
\item[\tt XXXX-PPPP.in:XXXX-PPPP.score:.tmpl] ~ \\
make .score file from .in file using PPPP binary
\item[\tt XXXX-PPPP.in:XXXX-PPPP.score:JAVA.tmpl] ~ \\
make .score file from .in file using PPPP.jar binary
\end{itemlist}
\end{indpar}

Sequences of 4 identical capital letters in a row in the basename
are replaced by text from the source file name when a template
file is used.  {\tt PPPP} is always replaced by the problem name.
For example, if given the source file {\tt 01-000-reverser.in},
the destination file {\tt 01-000-reverser.score} may be made
by either of the last two template file named above.
Which if the two template files is used is determined by the
contents of the files and the problem directory, as described
below.

A {\tt .tmpl} file JSON-encodes a PHP array with the following
components:
\begin{indpar}[0.2in]
\begin{itemlist}
\item[\tt 'COMMANDS' => ['line',...]] ~
\label{TEMPLATE-COMMANDS} \\
A list of command lines that is parsed into a sequence of commands.
A command consists of a consecutive sequence of lines all but the
last of which end in \BSL.

In JSON each line is enclosed in double quotes \verb|"| and \BSL
is represented by \BSL\BSL.

\item[\tt 'LOCAL-REQUIRES' => ['filename',...]] ~ \\
Locally required files.
A list of files in the `local' {\tt accounts/AID/PROBLEM} directory that must
exist if the template is to be used.  These files
are linked into the working directory in which
the commands are executed.

For example, {\tt XXXX-PPPP.in:XXXX-PPPP.score:.tmpl} \\
lists {\tt PPPP} as locally required, whereas \\
{\tt XXXX-PPPP.in:XXXX-PPPP.score:JAVA.tmpl} \\
lists {\tt PPPP.jar} as locally required.


\item[\tt 'REMOTE-REQUIRES' => ['filename',...]] ~ \\
Remote required files.  Like locally required files but the
files must be in the `remote'
{\tt accounts/AID/PROBLEM/+parent+} directory.

\item[\tt 'REQUIRES' => ['filename',...]] ~ \\
Required files.  Like above but files can be in either the local
or remote directories; the local directory version is perferred if
both exist.

\item[\tt 'CREATABLE' => ['filename',...]] ~ \\
Creatable files.  If file does not otherwise exist and is
listed in REQUIRES or LOCAL-REQUIRES, the file will be automatically
created in the local directory.  Note that a REQUIRES file which
exists in the remote directory will be used from that directory
and not created.

\item[\tt 'KEEP' => ['filename',...]] ~ \\
Files that are to be `kept', that is, moved to the local problem
directory at the end of the job, if there are no errors or failed
checks (see CHECKS).

\item[\tt 'CHECKS' => ['check',...]] ~ \\
Checks to be run upon job completion before keeping any files.
A check has the form ['filename',...].   For all but the last
check, this means that the first named file should be non-existant
or empty, else the check fails, and if the check fails,
the files listed in the check should be shown to the user as
proof that the check failed.

An example check is \verb|["PPPP.cerr","PPPP.cc"]| which checks
that the compiler .cerr error output file is empty and if not
shows it and the .cc source code file.

The last check is the list of files
that should be shown to the user if the job has no error, none
of the previous checks fail, and the KEEP files are moved to the
local problem directory.  The last check is typically empty, that is [],
but the previous checks cannot be empty.

A check can also be just 'filename',
which is equivalent to ['filename'].

\item[\tt 'CONDITIION' => 'condition'] ~ \\
A condition to be satisfied if the template is to be used.
Most templates have no CONDITION.  The possible conditions are:
\begin{indpar}
\begin{itemlist}
\item['UPLOAD filename'] ~ \\
The job is being run to verify the named file which has
just been uploaded using the Problem Page.
\item['SUBMIT'] ~ \\
The job is being run as part of a Run Page submission.
\end{itemlist}
\end{indpar}

\end{itemlist}
\end{indpar}


\newpage

\section{Web Pages}

\subsection{Index Page}

The Index Page is required by every other EPM .php page
and does initial setup for all EPM .php pages.  It also
functions as the initial file for accessing the EPM
server and reroutes these accesses to the Login Page.

\begin{center}
{\bf Index Page Requires}
\\[1ex]
\begin{tabular}{ll}
\TT{include/parameters.php} \\
\TT{include/epm\_abort.php} & only if aborting \\
\TT{include/epm\_random.php} & only for 'GET's to pages setting
                               \$epm\_ID\_init \\
\end{tabular}
\\[3ex]
{\bf Index Page Files}
\\[1ex]
\begin{tabular}{lllll}
\TT{error.log}			& create  & append & - \\
\TT{debug.log}			& -  & - & - \\
\TT{admin/teams/AID/+rw+}       & create  & lock   & read \\
\TT{accounts/AID/+read-write+}  & create  & append & - \\
\TT{accounts/AID/+read-only+}   & create  & append & - \\
\end{tabular}
\\[3ex]
{\bf Index Page Session Data}
\\[1ex]
\begin{tabular}{lllll}
\TT{EPM\_IPADDR}	& -  & -      & read \\
\TT{EPM\_AID}		& -  & -      & read \\
\TT{EPM\_UID}		& -  & -      & read \\
\TT{EPM\_EMAIL}		& -  & -      & read \\
\TT{EPM\_IS\_TEAM}	& -  & -      & read \\
\TT{EPM\_ABORT}		& -  & -      & read \\
\TT{EPM\_TIME}		& -  & -      & read \\
\TT{EPM\_PAGE[\$id\_type$^*$]}	& create  & update  & read \\
\TT{EPM\_ID\_GEN[\$id\_type$^*$]}	& create  & update  & read \\
\end{tabular}
\\[1ex]
$^*$ \$id\_type is "+main+" for main tab page,\\
PROBLEM name for problem tab page, and \\
"+view+" for view window page
\\[3ex]
{\bf Index Page Global Data}
\end{center}

The following are global variables set just before index.php
is required by another page.

\begin{center}
\begin{tabular}{lp{4.5in}}
\TT{\$epm\_page\_type}	& One of: \begin{tabular}[t]{ll}
                          +main+ & main tab page \\
			  +problem+ & some problem tab page \\
			  +view+ & view window page \\
			  +no-post+ & view window page that \\
			            & does no POSTs \\
			  +download+ & page that just downloads a file \\
			  \end{tabular}
\\[0.5ex]
\TT{\$epm\_ID\_init}	& If set re-initializes \$ID generator;
                          see \$ID below. \\
\end{tabular}
\end{center}

The following are global variables defined by index.php when it is
required at the beginning of an EPM .php page, and usable
by the remainder of that page.  For other such parameters,
see the include/parameters.php file.

\begin{center}\label{INDEX-DEFINED-GLOBAL-VARIABLES}
\begin{tabular}{lp{4.0in}}
\TT{\$epm\_method}	& the request method,
                          either 'GET' or 'POST' \\
\STACK{\TT{\$epm\_root}\\\TT{\$epm\_self}}
    & ROOT and SELF, where the URL used to access a page is HOST/ROOT/SELF
      and SELF either has the form /page/... or the form /index.php \\
\TT{\$epm\_web}	& the EPM web directory W \sref{DIRECTORIES}{MAIN-DIRECTORIES}
			\\
\TT{\$rw}	& true if request is being processed in read-write mode;
                  false if in read-only mode \\
\TT{\$aid}	& AID (\$\_SESSION['EPM\_AID']) if set \\
\TT{\$uid}	& UID (\$\_SESSION['EPM\_UID']) if set \\
\TT{\$lname}	& login name, either AID if AID == UID, or AID:EMAIL
                  if AID != UID \\
\TT{\$is\_team}	& true iff AID is a team ID so login is a team member login
		  (\$\_SESSION['EPM\_IS\_TEAM']) \\
\TT{\$ID}	& the identifier which must be presented by the next
                  request (as ?id=\$ID) unless the next page requested
		  sets \$epm\_ID\_init; see EPM\_ID\_GEN on
		  \pagref{EPM_ID_GEN} \\
\TT{\$data}	& same as \$\_SESSION['EPM\_PAGE'][\$id\_type];
                  used for per tab or view window data:
		  see \pagref{EPM_PAGE} \\
\TT{\$state}	& same as \$data['STATE']; set to 'normal'
                  by index.php on 'GET'
\end{tabular}

\end{center}

\subsubsection{Index Page File Formats}

\begin{indpar}
\begin{itemlist}
\item[\TT{error.log}:]~
\label{ERROR.LOG} \\
Records all PHP error messages that would normally
be in the HTTP server log, including messages generated
by the ERROR and WARN functions (see index.php).

Contains lines of format:%
\hspace{0.2in}CLASS ERRNO SELF AID (TIME)

followed by a stack trace.  Here
\begin{tabular}[t]{@{\hspace{0.2in}}lp{3.9in}}
CLASS & \small \{USER,EPM,SYSTEM\}\_\{WARNING,NOTICE,ERROR\} \\
ERRNO & PHP error number \\
SELF  & page name relative to W (EPM\_SELF)\\
AID   & account ID, or EMAIL if account ID not available \\
TIME  & session time (EPM\_TIME), if available
\end{tabular}

\item[\TT{debug.log}:]~
\label{DEBUG.LOG} \\
Contains lines output by the DEBUG function in parameters.php.
Not actually specific to index.php or any page.
See \$epm\_debug and the DEBUG function in parameters.php.

\item[\TT{admin/teams/AID/+rw+}:] See \pagref{ADMIN/TEAMS/TID/RW}

\item[\TT{accounts/AID/+read-only+}:]
\item[\TT{accounts/AID/+read-write+}:]\vspace*{-1ex}~
\label{ACCOUNTS/AID/READ-ONLY}
\label{ACCOUNTS/AID/READ-WRITE} \\
One line is appended at the end of each http request, of
the form:\\
\hspace*{0.5in}BEGIN-TIME END-TIME SELF AID UID
\\
where
\begin{tabular}[t]{@{\hspace{0.2in}}lp{3.7in}}
BEGIN-TIME & request processing start time in seconds \\
END-TIME & request processing end time in seconds \\
SELF  & page name relative to W (EPM\_SELF)\\
AID   & account ID \\
UID   & user ID \\
\end{tabular}
\\[1ex]
Times are typically to the nearest microsecond.
\\[1ex]
The +read-write+ file is written if the request is
read-write at its end, or the +read-only+ file is
written if the request is read-only.  The modification
time of the +read-write+ file is used to determine the
last time the account made a read-write request.

Download and xhttp requests are not recorded.

\item[\TT{accounts/AID/+download-UID+}:]~
\label{ACCOUNTS/AID/DOWNLOAD} \\
File to be downloaded by the Look Page.
E.g., a {\tt PROBLEM.tgz} file.



\end{itemlist}
\end{indpar}

\subsubsection{Index Page Session Variables}

\begin{indpar}[0.2in]
In the following \$id\_type is \$epm\_page\_type
when the latter is '+main+' or '+view+' and the problem
name when the latter is '+problem+'.
\begin{itemlist}
\item[\TT{EPM\_PAGE[\$id\_type]}:]~
\label{EPM_PAGE} \\
      Data specific to a particular tab or to the view
      window.  Same as \TT{\$data} global variable.
      Re-initialized on a 'GET' by index.php to:

      \centerline{ ['SELF' => \$epm\_self, 'STATE' => 'normal'] }

      Checked by index.php for 'POST's to be sure they target the
      page of the last 'GET' for the given \$id\_type.

\item[\TT{EPM\_ID\_GEN[\$id\_type]}:]~
\label{EPM_ID_GEN} \\
      The list [VALUE, KEY, IV] used to generate \$ID
      values.  The next \$ID value is VALUE.  When it
      is set, a new VALUE is generated by encrypting the
      old VALUE by KEY with IV as
      the initialization vector (it is always 0 and
      is included here as an optimization).
      Re-initialized for pages that set \$epm\_ID\_init;
      checked for other pages of \$epm\_page\_type
      "+main", "+problem+", or "+view+".


\end{itemlist}
\end{indpar}

For session variables just read by index.php, see other
EPM pages.

\subsubsection{Index Page Transactions}

See Page Initialization \sref{PAGE-INITIALIZATION}{INDEX-ACTIONS}.

\newpage

\subsection{Login Page}

\begin{center}
{\bf Login Page Requires}
\\[1ex]
\begin{tabular}{l}
\TT{page/index.php} \\
\TT{include/epm\_random.php} \\
\end{tabular}
\\[3ex]
{\bf Login Page Files}
\\[1ex]
\begin{tabular}{lllll}
\TT{admin/+blocking+}		& -	  & -      & read \\
\TT{admin/motd.html}		& -	  & -      & read \\
\TT{admin/+lock+}		& create  & update & read \\
\TT{admin/+random+}		& create  & update & read
\\[2ex]
\TT{admin/browser/TICKET}	& create  & -      & read \\
\TT{admin/email/EMAIL}		& -       & update & read \\
\TT{admin/users/UID/UID.login}	& -       & append & stat \\
\TT{admin/users/UID/GID.login}	& -       & append & stat \\
\TT{admin/teams/TID/MID.login}	& -       & append & stat \\
\end{tabular}
\\[3ex]
{\bf Login Page Session Data}
\\[1ex]
\begin{tabular}{lllll}
\TT{EPM\_EMAIL}	& create  & -      & - \\
\TT{EPM\_AID}	& create  & -      & read    \\
\TT{EPM\_UID}	& create  & -      & -    \\
\TT{EPM\_IS\_TEAM}
		& create  & -      & -    \\
\TT{EPM\_IPADDR}& create  & -      & read \\
\TT{EPM\_TIME}
                & create  & -      & read \\
\TT{EPM\_ABORT}
                & create  & -      & - \\
\end{tabular}
\end{center}

\subsubsection{Login Page File Formats}

\begin{indpar}
\begin{itemlist}
\item[\TT{admin/+blocking+}:]~
\label{ADMIN/BLOCKING} \\
Lines of format:\hspace{0.5in}SIGN RE \\
\begin{tabular}[t]{@{\hspace{0.2in}}lp{3.9in}}
SIGN & {\tt +} to not block, {\tt -} to block \\
RE & regular expression matched to the entire email name
     (e.g., {\tt .*} matches any email name and
     {\tt .*\textbackslash.edu} matches any email
     name ending in {\tt .edu})
\end{tabular}
\\
\begin{itemize}
\item The lines are read in order and the first line
with RE matching the login name EMAIL is used to
not block or block the EMAIL.  If no line matches,
the EMAIL is \underline{not} blocked.
\item Blank lines and whose first non-whitespace
character is {\tt \#} are ignored.  Various forms
of within-line whitespace are equivalent, and
whitespace at beginning or end of a line is ignored.
\end{itemize}

\item[\TT{admin/motd.html}:]~
\label{ADMIN/MOTD} \\
An HTML file that is included inside a {\tt <div>\ldots</div>}
block that gives the `message of the day' on the Login Page.  Typically
this file consists of some {\tt <p>} paragraphs.
If the file does not exist, the {\tt <div>\ldots</div>}
block is not created.

\item[\TT{admin/+lock+}:]~
\label{ADMIN/LOCK} \\
All transactions within the {\tt admin} directory
(i.e., all http requests that access files or subdirectories
within {\tt admin})
begin by calling the {\tt parameters.php} {\tt LOCK}
function to lock the {\tt admin} directory.  This function locks the
directory by creating if necessary and locking this {\tt +lock+} file
for the course of the transaction.  Note there are \underline{no}
EPM transactions longer than a single http request.

\item[\TT{admin/+random+}:]~
\label{ADMIN/RANDOM} \\
The pseudo-random number generator in {\tt include/\EOL
epm\_random.php} exclusively creates, updates, an reads this file.

\item[\TT{admin/browser/TICKET} (ticket file):] T AID EMAIL
\label{ADMIN/TICKET/TICKET} \\
\begin{tabular}[t]{lp{4.0in}}
TICKET & ticket proper; 32 hexadecimal digit ticket number \\
T & ticket type; `c' for confirmation number; `a' for automatic \\
AID & account ID: \\
    & ~~~ team ID (TID) if ticket is for team member login \\
    & ~~~ user ID (UID) if ticket is for guest login \\
    & ~~~ '-' if ticket is for user login \\
EMAIL & Email address (identifying user account) \\
\end{tabular}
\\
\begin{itemize}
\item When a user initially logs in to create an account,
the UID is not known when the ticket is created.
\end{itemize}

\item[\TT{admin/email/EMAIL} (regular email file):] UID ACOUNT ATIME
\label{ADMIN/EMAIL/EMAIL} \\
\begin{tabular}[t]{lp{4.0in}}
EMAIL & Email address encoded with PHP rawurlencode \\
UID & user ID \\
ACOUNT & Number of auto-login periods completed so far. \\
ATIME & Start time of newest (incomplete) auto-login period. \\
\end{tabular}

\item[\TT{admin/email/EMAIL} (pre-login email file):] - TID ...
\label{ADMIN/EMAIL/EMAIL-PRE-LOGIN} \\
\begin{tabular}[t]{lp{4.0in}}
EMAIL & Email address encoded with PHP rawurlencode \\
TID & Team user ID (may be more than one) \\
\end{tabular}
\\
\begin{itemize}
\item This form of email file is created by the User Page when
a team member is assigned the given EMAIL before the member
has an account or EMAIL has been added to an existing account.
The TID's list \underline{all} the team IDs that
\underline{might} in their {\tt TID.info} file
have a member which has this EMAIL and no UID.
A TID might be listed whose
{\tt TID.info} file no longer contains the EMAIL.
\\[1ex]
When the pre-login form is converted to a regular form,
the list of TID's is used to convert any matching EMAIL members
in {\tt TID.info} files to UID(EMAIL) members.
\end{itemize}

\item[\TT{admin/users/UID/UID.login} (login log):]
\item[\TT{admin/teams/TID/UID.login} (login log):]\vspace*{-1ex}
\item[\TT{admin/users/UID/GID.login} (login log):]\vspace*{-1ex}~
\label{ADMIN/USERS/XID/YID.LOGIN} \\
Lines of format:\hspace{0.5in}TIME EMAIL IPADDR BROWSER \\
\begin{tabular}[t]{@{\hspace{0.2in}}lp{3.9in}}
UID & User ID \\
TID & Team ID \\
GID & Guest User ID \\
TIME & Session time for login (EPM\_TIME) \\
EMAIL & Email address used for login (EPM\_EMAIL) \\
IPADDR & IP address for session (EPM\_IPADDR) \\
BROWSER & \STACK{
          \$\_SERVER['HTTP\_USER\_AGENT'] with `(...)'s\\
	  removed and horizontal spaces replaced by `\TT{;}'s} \\
\end{tabular}
\\
\begin{itemize}
\item
A login with name AID:EMAIL is valid iff the file
{\tt .../AID/UID.login} exists for UID the user ID associated
with EMAIL.
\item Upon login, a line is appended to the appropriate
the {\tt .login} file, and then that file's name and modification
time are stored in EPM\_ABORT and used to abort a session if another session
logs in with the same AID:EMAIL and appends to the file, thus
changing its modification time.
\end{itemize}


\end{itemlist}
\end{indpar}

\subsubsection{Login Page Session Variables}
\label{LOGIN-PAGE-SESSION-VARIABLES}

\begin{indpar}[0.2in]
\begin{tabular}[t]{lp{4.5in}}
\TT{EPM\_EMAIL}\label{EPM_EMAIL}
    & EMAIL entered by user into browser; set by Login Page when either
      (1) EMAIL is to be transferred to user.php for a new user,
      or (2) browser sends TICKET which identifies
      EMAIL and EPM\_UID is being set.
\\[0.5ex]
\TT{EPM\_AID}\label{EPM_AID}
    & Account ID, either user or team; set by Login Page when a valid
      TICKET is received, and set by User Page for new users.
      This equals EPM\_UID for a user login, is the team ID for
      team member login, and is the host user ID of the EMAIL guest for
      a guest login. 
\\[0.5ex]
\TT{EPM\_UID}\label{EPM_UID}
    & User ID associated with EPM\_EMAIL.
      Set when EPM\_\EOL AID is set.
\\[0.5ex]
\TT{EPM\_IS\_TEAM}\label{EPM_IS_TEAM}
    & True iff EPM\_AID is team ID;
      Set when EPM\_AID is set.
\\[0.5ex]
\TT{EPM\_IPADDR}\label{EPM_IPADDR}
    & Set to \$\_SERVER['REMOTE\_ADDR'] by Login Page when EPM\_\EOL AID is
      not yet set.
\\[0.5ex]
\TT{EPM\_TIME}\label{EPM_TIME}
    & Set to \$\_SERVER['REQUEST\_TIME'] formatted by \$epm\_\EOL format\_time
      by Login Page if EPM\_AID is not yet set.
\\[0.5ex]
\TT{EPM\_ABORT}\label{EPM_ABORT}
    & Set to [FILE,MTIME] where MTIME is the mod time of \$epm\_data/FILE
      and the session must abort if the mod time of this file changes.
      Here FILE is admin/users/AID/UID.login to which a line is appended
      whenever EPM\_AID is set for a session.
\end{tabular}
\end{indpar}


\subsubsection{Login Page Transactions}

\begin{enumerate}
\item If regular form admin/emails/EMAIL exists
      log existing user in and go to Project Page.  The browser
      first gets a ticket which it sends to the server, and
      the ticket specifies the EMAIL.
\begin{enumerate}
\item Browser can look EMAIL up in browser's local memory to get
      ticket to send to server, or if this ticket does not exist
      or is invalid,
\item Browser can send EMAIL to server and get confirmation number back to use
      as a ticket.
\end{enumerate}
\item Otherwise, if no regular form admin/emails/EMAIL exists, give
      the browser a confirmation number to use as ticket, and upon
      receiving this set EPM\_EMAIL and give the browser a new
      automatic ticket and instruct the browser to
      go to User Page to create new user.
\end{enumerate}

\newpage

\subsection{User Page}

\begin{center}
{\bf User Page Files}
\\[1ex]
\begin{tabular}{lllll}
\TT{admin/email/EMAIL}	& create  & update & read \\
\TT{admin/users/UID/UID.info}
			& create  & update & read \\
\TT{admin/teams/TID/TID.info}
			& create  & update & read \\
\TT{admin/users/UID/UID.login}
			& -       & append & stat \\
\TT{admin/users/UID/GID.login}
			& -       & append & stat \\
\TT{admin/teams/TID/UID.login}
			& -       & append & stat \\
\TT{admin/users/UID/UID.inactive}
			& create  & -      & - \\
\TT{admin/users/UID/GID.inactive}
			& create  & -      & - \\
\TT{admin/teams/TID/UID.inactive}
			& create  & -      & - \\
\TT{admin/users/UID/manager}
			& create  & update & read \\
\TT{admin/users/UID/member}
			& create  & update & read \\
\TT{admin/teams/TID/+rw+}
			& create  & update & read \\
\TT{admin/users/UID/+actions+}
			& create  & append & - \\
\TT{admin/teams/TID/+actions+}
			& create  & append & - \\
\TT{admin/+actions+}
			& create  & append & - \\
\end{tabular}
\\[3ex]
{\bf User Page Session Data}
\\[1ex]
\begin{tabular}{llll}
\TT{EPM\_USER}	& create  & update & read \\
\TT{EPM\_EMAIL}	& -       & -      & read \\
\TT{EPM\_AID}	& create  & -      & read \\
\TT{EPM\_UID}	& create  & -      & read \\
\TT{EPM\_IS\_TEAM}
                & create  & -      & read \\
\TT{EPM\_IPADDR}& -       & -      & read \\
\TT{EPM\_TIME}  & -       & -      & read \\
\TT{EPM\_ABORT} & create  & -      & - \\
\end{tabular}
\end{center}

\subsubsection{User Page File Formats}

\begin{indpar}
\begin{itemlist}
\item[\TT{admin/email/EMAIL}:] see \pagref{ADMIN/EMAIL/EMAIL} 
\item[\TT{admin/users/UID/UID.info} (user info file):]~
\label{ADMIN/USERS/UID/UID.INFO} \\
JSON file with the following components:
\begin{tabular}[t]{ll}
\TT{'uid'} & UID \\
\TT{'emails'} & \TT{[} EMAIL \{ \TT{,} EMAIL \}\STAR{} \TT{]} \\
\TT{'guests'} & \TT{[} GID \{ \TT{,} GID \}\STAR{} \TT{]}
                (may be missing) \\
\TT{'full\_name'} & TEXT \\
\TT{'organization'} & TEXT \\
\TT{'location'} & TEXT \\
\end{tabular}
\\
where
\\
\begin{tabular}[t]{lp{4.0in}}
UID & user ID (i.e., an account ID) for user; cannot be changed once
      account is created \\
EMAIL & e-mail address for user \\
GID & UID for guest of user \\
TEXT & plain text (with a minimum and maximum allowed length) \\
\end{tabular}
\\
\begin{itemize}
\item When a team UID.info file is created, MIDs are specified
as EMAILs which are resolved if possible to PIDs.
\item When a person initially creates an account, all
UID.info files are searched and if any have MIDs matching
the new account EMAIL, they are resolved to PIDs.
\end{itemize}

\item[\TT{admin/users/TID/TID.info} (user info file):]~
\label{ADMIN/USERS/TID/TID.INFO} \\
JSON file with the following components:
\begin{tabular}[t]{ll}
\TT{'tid'} & TID \\
\TT{'manager'} & MANAGER \\
\TT{'members'} & \TT{[} MEMBER \{ \TT{,} MEMBER \}\STAR{} \TT{]}
                (may be missing) \\
\TT{'full\_name'} & TEXT \\
\TT{'organization'} & TEXT \\
\TT{'location'} & TEXT \\
\end{tabular}
\\
where
\\
\begin{tabular}[t]{lp{4.0in}}
TID & team ID (i.e., an account ID) for team; cannot be changed once
      account is created \\
MANAGER & UID of the manager of team \\
MEMBER & one of: \begin{tabular}[t]{l}
                 MID \\
		 (EMAIL) \\
		 MID(EMAIL) \\
		 \end{tabular} \\
MID & UID of member of team \\
EMAIL & EMAIL of member of team as of time member was added to team  \\
TEXT & plain text (with a minimum and maximum allowed length) \\
\end{tabular}
\\
\begin{itemize}
\item A MEMBER may be specified as an EMAIL or a MID.
If specified as an EMAIL, and a regular {\tt admin/email/EMAIL}
(\pagref{ADMIN/EMAIL/EMAIL}) exists,
the MID is added.  If specified as an EMAIL, and no
regular {\tt admin/email/EMAIL} file exists, the TID is added to
a pre-login {\tt admin/email/EMAIL} (\pagref{ADMIN/EMAIL/EMAIL-PRE-LOGIN}),
which is created if it does not exist.
\item When a user initially creates an account with an EMAIL for which
a pre-login {\tt admin/email/EMAIL} file exists, the TID.info files
for all TIDs listed in the pre-login file are searched for any MEMBERs
of the form `(EMAIL)', and when one is found, its MID is added to it.
Similarly if EMAIL is added to an existing user account.
\end{itemize}

\item[\TT{admin/users/UID/UID.login} (login log):]
\item[\TT{admin/teams/TID/UID.login} (login log):]\vspace*{-1ex}
\item[\TT{admin/users/UID/GID.login} (login log):]\vspace*{-1ex}
see \pagref{ADMIN/USERS/XID/YID.LOGIN}

\item[\TT{admin/teams/TID/UID.inactive}:]
\item[\TT{admin/users/UID/GID.inactive}:]\vspace*{-1ex} ~
\label{ADMIN/USERS/XID/YID.INACTIVE} \\
Inactive {\tt .login} file, made by renaming {\tt .login} file
when UID is no longer a member of TID team or GID is no longer
a guest of UID.  May be reactivated by renaming to {\tt .login}
file.

\item[\TT{admin/users/UID/manager}:] ~
\label{ADMIN/USERS/UID/MANAGER} \\
A a list of single space separated TIDs of the teams of which
user UID is a manager.

\item[\TT{admin/users/UID/member}:] ~
\label{ADMIN/USERS/UID/MEMBER} \\
A a list of single space separated TIDs of the teams of which
user UID is a member.

\item[\TT{admin/teams/TID/+rw+}:] ~
\label{ADMIN/TEAMS/TID/RW} \\
Either a single UID of the team member whose login currently
has read-write mode, or blank if no such.  This file is locked
by itself for exclusive use by team member login requests,
and this is independent of any {\tt +lock+} file locking.
The lock is released immediately for read-only requests, but
is held to the end of read-write requests.


\item[\TT{admin/users/UID/+actions+}:]
\item[\TT{admin/teams/TID/+actions+}:]\vspace*{-1ex} ~
\label{ADMIN/XXXX/XID/ACTIONS} \\
Lines of format:\hspace{0.5in}TIME AID info KEY OP VALUE \\
\begin{tabular}[t]{@{\hspace{0.2in}}lp{3.9in}}
TIME & Session time for login (EPM\_TIME) \\
AID & equals UID or TID from file name \\
KEY & {\tt .info} file JSON key \\
OP & {\tt =} if non-list KEY reset, {\tt +} if addition to KEY's list,
     {\tt -} if deletion from KEY's list \\
VALUE & value given to non-list KEY, added to KEY's list,
        or deleted from KEY's list \\
\end{tabular}
\\
\begin{itemize}
\item Updates to {\tt AID.info} file are logged by writting lines
to {\tt admin/*/AID/+actions+} file.
\end{itemize}

\item[\TT{admin/+actions+}:] ~
\label{ADMIN/ACTIONS} \\
Any line writted to an {\tt admin/*/AID/+actions+} file is
also written to this file.

\end{itemlist}
\end{indpar}

\subsubsection{User Page Session Variables}

\begin{indpar}[0.2in]
\begin{tabular}[t]{lp{4.5in}}
\TT{EPM\_USER}\label{EPM_USER}
    & User Page Permanent State: \\
    & ~~ \TT{'UID'} {\tt =>} currently selected user \\
    & ~~ \TT{'TID'} {\tt =>} currently selected team \\
    & ~~ \TT{'TID\_LIST'} {\tt =>} currently selected team list; one of: \\
    & ~~~~~~ \TT{'all'} all teams \\
    & ~~~~~~ \TT{'manager'} teams for which UID is the manager \\
    & ~~~~~~ \TT{'member'} teams for which UID is a member
\\[1ex]
Other & see Login Page Session Variables, \pagref{LOGIN-PAGE-SESSION-VARIABLES}
\end{tabular}
\end{indpar}

\subsubsection{User Page Transactions}

\begin{enumerate}
\item If EPM\_UID not set, get data for new user and create
      new user account if data acceptable.  Otherwise, or
      after creating new user account, display {\tt .info}
      data for all users and all teams.
\item Allow the current user to edit their own {\tt .info} data.
\item If the current user is the manager of a team, allow that
      team's {\tt .info} data to be edited.
\item Allow the current user to create a new team of which the
      current user is a manager.
\item NOTE: team member and guest logins cannot edit user or
      team {\tt .info} or create new teams.
\item Allow a current read-only user to force a switch to read-write.
\end{enumerate}

\newpage

\subsection{Problem Page}

\begin{center}
{\bf Problem Page Visible Files}
\label{PROBLEM-VISIBLE-FILES}
\\[1ex]
\begin{tabular}{lllll}
\TT{accounts/AID/PROBLEM}	        & create  & update & read & delete
\\[1ex]
\TT{accounts/AID/PROBLEM/PROBLEM.tex}	& upload  & -      & read & delete \\
\TT{accounts/AID/PROBLEM/PROBLEM.pdf}	& create  & -      & read & delete
\\[1ex]
\TT{accounts/AID/PROBLEM/PROBLEM.c}	& upload  & -      & read & delete \\
\TT{accounts/AID/PROBLEM/PROBLEM.cc}	& upload  & -      & read & delete \\
\TT{accounts/AID/PROBLEM/PROBLEM.java}	& upload  & -      & read & delete \\
\TT{accounts/AID/PROBLEM/PROBLEM.py}	& upload  & -      & read & delete \\
\TT{accounts/AID/PROBLEM/PROBLEM}	& create  & -      & read & delete \\
\TT{accounts/AID/PROBLEM/PROBLEM.jar}	& create  & -      & read & delete \\
\TT{accounts/AID/PROBLEM/PROBLEM.pyc}	& create  & -      & read & delete
\\[1ex]
\TT{accounts/AID/PROBLEM/YYYY-PROBLEM.c} & upload  & -     & read & delete \\
\TT{accounts/AID/PROBLEM/YYYY-PROBLEM.cc} & upload  & -    & read & delete \\
\TT{accounts/AID/PROBLEM/YYYY-PROBLEM.java} & upload  & -  & read & delete \\
\TT{accounts/AID/PROBLEM/YYYY-PROBLEM.py} & upload & -     & read & delete \\
\TT{accounts/AID/PROBLEM/YYYY-PROBLEM}	& create  & -      & read & delete \\
\TT{accounts/AID/PROBLEM/YYYY-PROBLEM.jar} & create  & -   & read & delete \\
\TT{accounts/AID/PROBLEM/YYYY-PROBLEM.pyc} & create  & -   & read & delete
\\[1ex]
\TT{accounts/AID/PROBLEM/XXXX-PROBLEM.in} & upload  & -    & read & delete \\
\TT{accounts/AID/PROBLEM/XXXX-PROBLEM.sin} & create  & -   & read & delete \\
\TT{accounts/AID/PROBLEM/XXXX-PROBLEM.sout} & create  & -  & read & delete \\
\TT{accounts/AID/PROBLEM/XXXX-PROBLEM.fout} & create  & -  & read & delete \\
\TT{accounts/AID/PROBLEM/XXXX-PROBLEM.dout} & create  & -  & read & delete \\
\TT{accounts/AID/PROBLEM/XXXX-PROBLEM.ftest} & create  & - & read & delete \\
\TT{accounts/AID/PROBLEM/XXXX-PROBLEM.score} & create  & - & read & delete
\\[1ex]
\TT{accounts/AID/PROBLEM/ZZZZ-PROBLEM.run}  & upload  & - & read & delete \\
\TT{accounts/AID/PROBLEM/XXXX-PROBLEM.rout} & -  & -  & read & delete \\
\end{tabular}
\\[1ex]
Special values for YYYY: \TT{generate}, \TT{filter}, \TT{monitor}, \TT{display}

\newpage

{\bf Problem Page Parent Files}
\\[1ex]
\begin{tabular}{lllll}
\TT{projects/PROJECT/PROBLEM}	        	& -  & - & read & - \\
\TT{projects/PROJECT/PROBLEM/PROBLEM.pdf}    	& -  & - & read & - \\
\TT{projects/PROJECT/PROBLEM/PROBLEM.optn}    	& -  & - & read & - \\
\TT{projects/PROJECT/PROBLEM/generate-PROBLEM} 	& -  & - & read & - \\
\TT{projects/PROJECT/PROBLEM/filter-PROBLEM} 	& -  & - & read & - \\
\TT{projects/PROJECT/PROBLEM/display-PROBLEM} 	& -  & - & read & - \\
\TT{projects/PROJECT/PROBLEM/monitor-PROBLEM} 	& -  & - & read & - \\
\TT{projects/PROJECT/PROBLEM/XXXX-PROBLEM.in}	& -  & - & read & - \\
\TT{projects/PROJECT/PROBLEM/XXXX-PROBLEM.ftest} & -  & - & read & - \\
\TT{projects/PROJECT/PROBLEM/ZZZZ-PROBLEM.run} & -  & - & read & -
\\[1ex]
\end{tabular}
\\\bigskip
{\bf Problem Page Maintenance Files}
\\[1ex]
\begin{tabular}{lllll}
\TT{accounts/AID/PROBLEM/+parent+}	& -  & - & read & - \\
\TT{accounts/AID/PROBLEM/PROBLEM.optn}	& -  & - & read & - \\
\TT{accounts/AID/PROBLEM/+altered+}	& create  & touch & stat & - \\
\TT{accounts/AID/PROBLEM/+changes+}	& create  & append & - & - \\
\TT{accounts/AID/PROBLEM/+actions+}	& create  & append & - & - \\
\TT{projects/+priv+}			& -  & - & read & - \\
\TT{projects/PROJECT/+priv+}		& -  & - & read & - \\
\TT{projects/PROJECT/+block+}		& -  & - & read & - \\
\TT{projects/PROJECT/PROBLEM/+priv+}	& -  & - & read & - \\
\TT{projects/PROJECT/PROBLEM/+block+}	& -  & - & read & - \\
\end{tabular}
\\\bigskip
{\bf Problem Page Work Files}
\\[1ex]
\begin{tabular}{lllll}
\TT{accounts/AID/PROBLEM/+work+/XXXX-PROBLEM.sh}     & create  & - & - & - \\
\TT{accounts/AID/PROBLEM/+work+/XXXX-PROBLEM.shout}  & create  & append & read
                                                                        & - \\
\TT{accounts/AID/PROBLEM/+work+/XXXX-PROBLEM.sherr}  & create  & append & -
                                                                        & - \\
\TT{accounts/AID/PROBLEM/+work+/XXXX-PROBLEM.*stat}  & create  & update & read
                                                                        & - \\
\end{tabular}
\\[2ex]
Other files are linked into the {\tt +work+} directory
as per templates \\
or are created by template commands
\\[3ex]
{\bf Problem Page Session Data}
\\[1ex]
\begin{tabular}{lllll}
\TT{EPM\_PROBLEM[problem]}
		& create  & update & read \\
\end{tabular}
\\[3ex]
\TT{problem} is the value of the \verb|'problem'| \\
parameter to page GETs and POSTs
\end{center}

\subsubsection{Problem Page File Formats}

\begin{indpar}
\begin{itemlist}
\item[Visible Files:] see Help Page
\item[Parent Files:] see Help Page and following
\item[\TT{accounts/AID/PROBLEM/+parent+}:]~\\
    symbolic link to {\tt projects/PROJECT/PROBLEM}
\item[\TT{accounts/AID/PROBLEM/PROBLEM.optn}:] see \pagref{PROBLEM.OPTN}
\item[\TT{accounts/AID/PROBLEM/+altered+}:]~
\label{PROBLEM/ALTERED} \\
    empty file; only modification time is used;
    this file is touched by every transaction that
    creates, deletes, or modifies a file in the problem directory
\item[\TT{accounts/AID/PROBLEM/+changes+}:]~
\label{PULL-CHANGES} \\
    Log of changes to \TT{accounts/AID/PROBLEM} made by pulling problem.
    This is a descriptive file with no fixed format.
\item[\TT{accounts/AID/PROBLEM/+actions+}:]~
    see \pagref{ACCOUNT-ACTIONS}
\item[\TT{accounts/AID/PROBLEM/+work+}:]~
\label{PROBLEM/WORK} \\
    directory created when commands from a template are to be
    executed; the commands run with this directory as the current
    directory
\item[\TT{accounts/AID/PROBLEM/+work+/XXXX-PROBLEM.sh}:]~ \\
This is the bash script that is executed to run the template
determined job.  Before each bash command {\tt n} is set to
specifiy the command.  The commands in order are:
\begin{center}
\begin{tabular}{lp{4.0in}}
n=B & bash initialization commands setting traps for signals
      and command errors and writing PID in first output line \\
n=\# & template command beginning on template command line number \# \\
n=D  & `{\tt exit 0}' command after template commands \\
\end{tabular}
\end{center}
Upon starting, the script writes to the .shout file the line:
\begin{center}
$pid$ {\tt PID}
\end{center}
where $pid$ is the ID of the process running the script (which
can be used to send the script a stop signal).

On termination the script writes to the .shout file the line:
\begin{center}
{\tt ::}$n$ $e$ {\tt DONE}
\end{center}
where $n$ is the value of {\tt n} at the beginning of the
last bash command executed, and $e$ is the exit code.

See include/epm\_make.php for more details.

\item[\TT{accounts/AID/PROBLEM/+work+/XXXX-PROBLEM.shout}:]~ \\
This is the standard output of the bash shell script.
Template commands redirect their standard output so it does not appear here.
\item[\TT{accounts/AID/PROBLEM/+work+/XXXX-PROBLEM.sherr}:]~ \\
This is the standard error of the bash shell script.
Template commands redirect their standard error so it does not appear here.
\end{itemlist}
\end{indpar}

\subsubsection{Problem Page Session Variables}

\begin{indpar}
\begin{itemlist}
\item[\TT{EPM\_PROBLEM[problem]}:] ~
\label{EPM_PROBLEM} \\
    Problem Page Permanent State
\item[\TT{EPM\_PROBLEM[problem]['ORDER']}:]
    currently selected problem list order (see Help Page); one of:
    \begin{tabular}[t]{l}
    \TT{'extension'} \\
    \TT{'lexical'} \\
    \TT{'recent'} 
    \end{tabular}
\end{itemlist}
\end{indpar}

\subsubsection{Problem Page Transactions}

\begin{enumerate}
\item Display visible problem files.
\item Display visible +work+ directory files.
\item Display commands last executed.
\item Update command list with execution times and
      error messages.
\item Change order of visible files in listings (lexical,
      by-extension, or most-recent-first)
\item Make XXXX.FFF from XXXX.EEE using template.
\item Upload file XXXX.EEE and make XXXX.FFF from it using template
      (FFF is a function of EEE).
\item Link XXXX.EEE to YYYY-XXXX.EEE.
\item Start run of XXXX.run file (run finished by Run Page)
\item Delete selected visible files.
\item Delete problem.
\item Delete +work+ directory.
\end{enumerate}

\newpage

\subsection{Run Page}

\begin{center}
{\bf Run Page Visible Files}
\\[1ex]
\begin{tabular}{lllll}
\TT{accounts/AID/PROBLEM/ZZZZ-PROBLEM.run}  & -  & - & read & - \\
\TT{accounts/AID/PROBLEM/XXXX-PROBLEM.rout} & create  & append  & read & - \\
\TT{accounts/AID/PROBLEM/+run+/XXXX-PROBLEM.rerr}
					    & create  & append  & read & - \\
\end{tabular}
\\\bigskip
{\bf Run Page Run Files}
\\[1ex]
\begin{tabular}{lllll}
\TT{accounts/AID/PROBLEM/+run+/XXXX-PROBLEM.sh}     & create  & - & - & - \\
\TT{accounts/AID/PROBLEM/+run+/XXXX-PROBLEM.shout}  & create  & append & read
                                                                       & - \\
\TT{accounts/AID/PROBLEM/+run+/XXXX-PROBLEM.sherr}  & create  & append & -
                                                                       & - \\
\TT{accounts/AID/PROBLEM/+run+/XXXX-PROBLEM.stat}   & create  & append & read
                                                                       & - \\
\TT{accounts/AID/PROBLEM/+run+/XXXX-PROBLEM.run}    & link    & - & read & - \\
\TT{accounts/AID/PROBLEM/+run+/XXXX-PROBLEM.rout}   & create  & append & read
                                                                       & - \\
\TT{accounts/AID/PROBLEM/+run+/XXXX-PROBLEM.rerr}   & create  & append & read
                                                                       & - \\
\end{tabular}
\\\bigskip
{\bf Run Page Maintenance Files}
\\[1ex]
\begin{tabular}{lllll}
\TT{projects/+priv+}			& -  & - & read & - \\
\TT{projects/PROJECT/+priv+}		& -  & - & read & - \\
\TT{projects/PROJECT/+block+}		& -  & - & read & - \\
\TT{projects/PROJECT/PROBLEM/+priv+}	& -  & - & read & - \\
\TT{projects/PROJECT/PROBLEM/+block+}	& -  & - & read & - \\
\end{tabular}
\end{center}

\subsubsection{Run Page File Formats}

\begin{indpar}
\begin{itemlist}
\item[\TT{accounts/AID/PROBLEM/+run+}:]~
\label{PROBLEM/RUN} \\
    directory created when a run is to be executed;
    the run executes with this directory as the current
    directory
\item[\TT{accounts/AID/PROBLEM/+run+/XXXX-PROBLEM.sh}:]
\item[\TT{accounts/AID/PROBLEM/+run+/XXXX-PROBLEM.shout}:]\vspace*{-1ex}
\item[\TT{accounts/AID/PROBLEM/+run+/XXXX-PROBLEM.sherr}:]\vspace*{-1ex} ~ \\
These have the same format and purpose as the similar {\tt +work+}
files (\pagref{PROBLEM/WORK}).  Also see Run Page Transactions Below.

\item[\TT{accounts/AID/PROBLEM/+run+/XXXX-PROBLEM.run}:]
\item[\TT{accounts/AID/PROBLEM/+run+/XXXX-PROBLEM.rout}:]\vspace*{-1ex}
\item[\TT{accounts/AID/PROBLEM/+run+/XXXX-PROBLEM.rerr}:]\vspace*{-1ex} ~ \\
See Run Page Transactions Below.

\end{itemlist}
\end{indpar}

\subsubsection{Run Page Transactions}

\begin{enumerate}
\item Display visible run files.
\item Execute runs.  A run is executed in a {\tt +run+}
      directory using a template consisting of the single
      command:
      \begin{center}
      \begin{tabular}{l}
      \tt \$BIN/epm\_run $s$ XXXX-PROBLEM.run \BSL \\
      \tt ~~~~ accounts/AID/PROBLEM/+work+ XXXX-PROBLEM.stat \BSL \\
      \tt ~~~~ > XXXX-PROBLEM.rout 2> XXXX-PROBLEM.rerr
      \end{tabular}
      \end{center}
      The resulting .sh, .shout, .sherr, .rout, and .rerr
      files are as they would be for commands executed from
      a template in the {\tt +work} directory.
      \\[1ex]
      See epm\_run document for more details.

\end{enumerate}

\newpage

\subsection{Option Page}

\begin{center}
{\bf Option Page Files}
\\[1ex]
\begin{tabular}{lllll}
\TT{accounts/AID/PROBLEM/PROBLEM.optn}  & create  & update & read & - \\
\TT{projects/PROJECT/PROBLEM/PROBLEM.optn} & -  & -  & read & - \\
\TT{H/template/template.optn} & -  & -  & read & - \\
\end{tabular}
\\\bigskip
{\bf Option Page Maintenance Files}
\\[1ex]
\begin{tabular}{lllll}
\TT{projects/+priv+}			& -  & - & read & - \\
\TT{projects/PROJECT/+priv+}		& -  & - & read & - \\
\TT{projects/PROJECT/+block+}		& -  & - & read & - \\
\TT{projects/PROJECT/PROBLEM/+priv+}	& -  & - & read & - \\
\TT{projects/PROJECT/PROBLEM/+block+}	& -  & - & read & - \\
\end{tabular}
\end{center}

\subsubsection{Option Page File Formats}

\begin{indpar}
\begin{itemlist}
\item[\TT{accounts/AID/PROBLEM/PROBLEM.optn}:]
\item[\TT{projects/PROJECT/PROBLEM/PROBLEM.optn}:]\vspace*{-1ex}
\item[\TT{H/template/template.optn}:]\vspace*{-1ex} ~
\label{PROBLEM.OPTN} \\
    JSON-encoding of PHP array defining options.
    The template.optn file has a different array layout
    from the other .optn file.
\end{itemlist}
\end{indpar}

{\bf PROBLEM.optn File Arrays:}

\begin{indpar}
\begin{itemlist}
\item[\tt 'option-name' => 'option-value'] ~ \\
Specifies that the named option has the given value.
\end{itemlist}
\end{indpar}

{\bf template.optn File Array:}
\label{TEMPLATE.OPTN}

\begin{indpar}
See the {\tt H/template/template.optn} file for examples.
This is the only file in EPM that has this format.

There are several types of array entries:
\begin{itemlist}

\item[\tt 'argument-name' => ['description' => 'text']] ~ \\
Specifies that `argument-name' names an argument with the
given text as a strictly-human readable description.
An argument-name, preceded by \$, may appear in a template
command (see COMMANDS, \pagref{TEMPLATE-COMMANDS}) and this
will be replaced by a space separated sequence of all the
argument-options assigned to
argument-name (see following).

\medskip

\newsavebox{\valoptbox}
\begin{lrbox}{\valoptbox}
\tt
[\begin{tabular}[t]{l}
'argname' => 'argument-name', \\
'values' => ['value',\ldots], \\
'default' => 'default-value', \\
'description' => 'text'] \\
\end{tabular}
\end{lrbox}
\item[\tt 'option-name' => \usebox{\valoptbox}] ~ \\
Describes an argument option that takes one of a fixed
set of values.  The option is included in the argument
named.

\medskip

\newsavebox{\argoptbox}
\begin{lrbox}{\argoptbox}
\tt
[\begin{tabular}[t]{l}
'argname' => 'argument-name', \\
'default' => 'default-value', \\
'description' => 'text'] \\
\end{tabular}
\end{lrbox}
\item[\tt 'option-name' => \usebox{\argoptbox}] ~ \\
Describes an argument option that takes a
string as a value.  The string may be any string
that has only letters,
digits, and the characters {\tt - + \_ @ : . , = /}.
The option is included in the argument named.

\medskip

\newsavebox{\numoptbox}
\begin{lrbox}{\numoptbox}
\tt
[\begin{tabular}[t]{l}
'valname' => 'value-name', \\
'type' => 'value-type', \\
'range' => ['min-value','max-value'], \\
'default' => 'default-value', \\
'description' => 'text'] \\
\end{tabular}
\end{lrbox}
\item[\tt 'option-name' => \usebox{\numoptbox}] ~ \\
Describes a number option that has a type and is in a
range.  The type can be `{\tt natural}', `{\tt integer}',
or `{\tt float}'.  Only decimal numbers are allowed.
The option may be included in any argument option by including
the value-name in the argument option; the value-name will
be replaced by the number option value (there is NO \$ in this case).

\end{itemlist}
\end{indpar}

\subsubsection{Option Page Transactions}

\begin{enumerate}
\item Display current problem options.  This is a composite
of {\tt H/template/template.optn}, with default values
overridden by {\tt +parent+/PROBLEM.optn}
if {\tt +parent+} exists, and with values then
overridden by {\tt PROBLEM.optn} in the local
problem directory if that exists.
\item Delete {\tt PROBLEM.optn} resetting the options
to the `inherited' options.
\item Edit {\tt PROBLEM.optn}.
\end{enumerate}

Note: The Project Page, when it pushes PROBLEM, merges
{\tt PROBLEM.optn} into {\tt +parent+/\EOL PROBLEM.optn} and
deletes {\tt PROBLEM.optn}.

\newpage

\subsection{Project Page}

\begin{center}

{\bf Project Page Visible Files}
\label{PROJECT-VISIBLE-FILES}
\\[1ex]
These are made visible by links to the local problem directory.
\\[1ex]
\begin{tabular}{lllll}
\TT{projects/PROJECT/PROBLEM/PROBLEM.pdf}    	& create  & replace & - & - \\
\TT{projects/PROJECT/PROBLEM/generate-PROBLEM} 	& create  & replace & - & - \\
\TT{projects/PROJECT/PROBLEM/filter-PROBLEM} 	& create  & replace & - & - \\
\TT{projects/PROJECT/PROBLEM/display-PROBLEM} 	& create  & replace & - & - \\
\TT{projects/PROJECT/PROBLEM/monitor-PROBLEM} 	& create  & replace & - & - \\
\TT{projects/PROJECT/PROBLEM/XXXX-PROBLEM.in}	& create  & replace & - & - \\
\TT{projects/PROJECT/PROBLEM/XXXX-PROBLEM.ftest} & create  & replace & - & - \\
\TT{projects/PROJECT/PROBLEM/ZZZZ-PROBLEM.run} & create  & replace & - & -
\\[1ex]
\end{tabular}
\\\bigskip
{\bf Project Page Maintenance Files}
\\[1ex]
\begin{tabular}{lllll}
\TT{projects/PROJECT/PROBLEM}	        & create  & update & read & - \\
\TT{projects/PROJECT/PROBLEM/PROBLEM.optn} & create  & update & read & delete \\
\TT{projects/PROJECT/PROBLEM/+actions+} & create  & append & - & - \\
\TT{projects/PROJECT/PROBLEM/+changes+} & create  & append & - & - \\
\TT{projects/PROJECT/PROBLEM/+lock+} & create  & update & read & - \\
\TT{projects/PROJECT/PROBLEM/+priv+} & -  & - & read & - \\
\TT{projects/PROJECT/PROBLEM/+block+}	& -  & - & read & - \\
\TT{projects/PROJECT/+actions+} & create  & append & - & - \\
\TT{projects/PROJECT/+priv+} & -  & - & read & - \\
\TT{projects/PROJECT/+block+}		& -  & - & read & - \\
\TT{projects/+priv+}			& -  & - & read & - \\
\TT{accounts/AID/+actions+} & create  & append & - & - \\
\TT{accounts/AID/+lists+}    	& create  & - & read & - \\
\TT{accounts/AID/+lists+/+favorites+}    	& create  & - & read & - \\
\end{tabular}

\newpage

{\bf Project Page Source Files}
\label{PROBLEM/SOURCES}
\\[1ex]
\begin{tabular}{lllll}
\FSTACK{projects}{/PROJECT/PROBLEM/\\+sources+/PROBLEM.tex}
				& create & - & read & - \\
\FSTACK{projects}{/PROJECT/PROBLEM/\\+sources+/PROBLEM.pdf}
				& create & - & read & - \\
\FSTACK{projects}{/PROJECT/PROBLEM/\\+sources+/PROBLEM.c}
				& create & - & read & - \\
\FSTACK{projects}{/PROJECT/PROBLEM/\\+sources+/PROBLEM.cc}
				& create & - & read & - \\
\FSTACK{projects}{/PROJECT/PROBLEM/\\+sources+/PROBLEM.java}
				& create & - & read & - \\
\FSTACK{projects}{/PROJECT/PROBLEM/\\+sources+/PROBLEM.py}
				& create & - & read & - \\
\FSTACK{projects}{/PROJECT/PROBLEM/\\+sources+/YYYY-PROBLEM.c}
				& create & - & read & - \\
\FSTACK{projects}{/PROJECT/PROBLEM/\\+sources+/YYYY-PROBLEM.cc}
				& create & - & read & - \\
\FSTACK{projects}{/PROJECT/PROBLEM/\\+sources+/YYYY-PROBLEM.java}
				& create & - & read & - \\
\FSTACK{projects}{/PROJECT/PROBLEM/\\+sources+/YYYY-PROBLEM.py}
				& create & - & read & - \\
\end{tabular}
\\\bigskip
{\bf Project Page Submit Files}
\label{PROBLEM/SUBMITS}
\\[1ex]
\begin{tabular}{lllll}
\FSTACK{projects}{/PROJECT/PROBLEM/\\+submits+/XXXX-PROBLEM.rout}
				    & create  & -  & read & - \\
\FSTACK{projects}{/PROJECT/PROBLEM/\\+submits+/+count+}
				    & create  & update  & read & - \\
\FSTACK{projects}{/PROJECT/PROBLEM/\\+submits+/+lock+}
				    & create  & update  & read & - \\
\end{tabular}
\\[2ex]
{\bf Project Page Session Data}
\\[1ex]
\begin{tabular}{lllll}
\TT{EPM\_PROJECT} & create  & update & read \\
\end{tabular}
\end{center}

\subsubsection{Project Page File Formats}

\begin{indpar}
\begin{itemlist}
\item[Visible Files:] see Help Page
\item[\TT{projects/PROJECT/PROBLEM/PROBLEM.optn}:] see \pagref{PROBLEM.OPTN}
\item[\TT{projects/PROJECT/PROBLEM/+actions+}:]
\item[\TT{projects/PROJECT/+actions+}:]\vspace*{-1ex} ~
    see \pagref{ACCOUNT-ACTIONS}
\item[\TT{projects/PROJECT/PROBLEM/+changes+}:]~
\label{PUSH-CHANGES} \\
    Log of changes to \TT{projects/PROJECT/PROBLEM} made by pushing problem.
    This is a descriptive file with no fixed format.
\item[\TT{projects/PROJECT/PROBLEM/+priv+}:]
\item[\TT{projects/PROJECT/+priv+}:]\vspace*{-1ex} ~
    see \pagref{PRIV}
\item[\TT{projects/PROJECT/PROBLEM/+lock+}:]~
\label{PROJECT/PROBLEM/LOCK} \\
Push an pull transactions involving the project problem
begin by calling the {\tt parameters.php} {\tt LOCK}
function to lock the {\tt projects/PROJECT/ PROBLEM} directory.
This function locks the
directory by creating if necessary and locking this {\tt +lock+} file
for the course of the transaction.  Note there are \underline{no}
EPM transactions longer than a single http request.
\item[\TT{accounts/AID/+lists+}:]
\item[\TT{accounts/AID/+lists+/+favorites+}:]\vspace*{-1ex}~
See \pagref{FAVORITES}.
\end{itemlist}
\end{indpar}


\subsubsection{Project Page Transactions}

\begin{enumerate}
\item Display list of problems to pull or push.
\item Compile `code' to pull or push a problem and an associated
      description of that code which can be displayed by the
      user and which will be copied into a {\tt +changes+} file
      if and when the code is executed.  See execute\_commands
      function in project.php for code details.

      Display warnings or errors generated by compilation.
\item Display code description associated with compiled code.
\item Execute compiled code to perform a push or pull.
\item Create a new problem and create a problem tab for it.
\item Create a problem tab for an existing problem.

\end{enumerate}

\newpage

\subsection{List Page}

\begin{center}

{\bf List Page Files}

\begin{tabular}{lllll}
\TT{accounts/AID/+lists+}    		& create  & update  & read & - \\
\TT{accounts/AID/+lists+/+favorites}   	& create  & -       & read & - \\
\TT{accounts/AID/+lists+/NAME.list}    	& create  & update  & read & delete \\
\TT{accounts/AID/+lists+/+actions+}    	& create  & append  & -    & - \\
\TT{accounts/AID/+actions+}    		& -       & append  & -    & - \\
\TT{projects/PROJECT/+lists+}		& create  & update  & read & - \\
\TT{projects/PROJECT/+lists+/NAME.list}	& create  & replace & read & delete \\
\TT{projects/PROJECT/+lists+/+actions+}	& create  & append  & -    & - \\
\TT{projects/PROJECT/+actions+}		& -       & append  & -    & - \\
\end{tabular}


\end{center}

\subsubsection{List Page File Formats}
\label{LIST-PAGE-FILE-FORMATS}

\begin{indpar}
\begin{itemlist}
\item[\TT{accounts/AID/+lists+/+favorites+}:] ~
\label{FAVORITES} \\
\begin{tabular}{@{}r@{~~~~~}l}
Lines of the form: & TIME~~USER~~NAME \\
or                 & TIME~~PROJECT~~- \\
\end{tabular}
\\[1ex]
For the first form of line, USER is `-' if the list is in
{\tt accounts/ AID/+lists+/NAME.list} and an account ID
if the list is linked to by
{\tt lists/USER:NAME.list}.

For the second form of line, PROJECT is `-' if the list
is the list of all the current account's problems
in {\tt accounts/AID}, and otherwise the list is the list
of all PROJECT problems in {\tt projects/PROJECT}.

The first page to read the {\tt +favorites} file creates it
and its containing directory if they do not exist.
When so created it contains the
`{\tt TIME - -}' list of the user's own problems (there might
be none) and the `{\tt TIME PROJECT -}' lists for all PROJECTs
for which the user has at least one privilege.

\item[\TT{accounts/AID/+lists+/NAME.list}:] ~
\label{LIST/NAME.LIST} \\
Lines of the form:\hspace{0.5in}TIME~~PROJECT~~PROBLEM
\\[1ex]
PROJECT is `-' if the PROBLEM is local in {\tt accounts/AID/PROBLEM}
and is otherwise the project containing the PROBLEM
in {\tt projects/ PROJECT/PROBLEM}.

\item[\TT{projects/PROJECT/+lists+/NAME.list}:] ~
    \label{LIST/PUBLISHED}\\
Copy made of some {\tt accounts/AID/+lists+/NAME.list} for some AID.

\item[\TT{accounts/AID/+lists+/+actions+}:]
\item[\TT{accounts/AID/+actions+}:]\vspace*{-1ex} ~ \\
\item[\TT{projects/PROJECT/+lists+/+actions+}:]\vspace*{-1ex} ~ \\
\item[\TT{projects/PROJECT/+actions+}:]\vspace*{-1ex} ~ \\
    See \pagref{ACCOUNT-ACTIONS}.

\end{itemlist}
\end{indpar}

\subsubsection{List Page Transactions}

\begin{enumerate}
\item Select list (one of two).
\item Cancel (unselect) list (one of two).
\item Edit list by copying elements from another list, deleting elements,
      or reordering elements.  This is done by JAVASCRIPT in the browser.
\item Save edited list.
\item Reset edited list to un-edited value.
\item Create new list by copying existing list, or create empty list
      if current list unselected.
\item Delete list.
\item Publish list (move or copy to project list).
\item Unpublish list (move or copy from project list).
\end{enumerate}

\newpage

\subsection{Favorites Page}

\begin{center}

{\bf Favorites Page Files}

\begin{tabular}{lllll}
\TT{accounts/AID/+lists+}    		& create  & -      & read & - \\
\TT{accounts/AID/+lists+/+favorites+}  	& create  & update & read & - \\
\TT{accounts/AID/+lists+/NAME.list}    	& -       & -      & read & - \\
\TT{lists/AID:NAME.list} 		& -       & -      & read & - \\
\end{tabular}


\end{center}

\subsubsection{Favorites Page File Formats}

\begin{indpar}
See List Page File Formats \pagref{LIST-PAGE-FILE-FORMATS}.
\end{indpar}

\subsubsection{Favorites Page Transactions}

\begin{enumerate}
\item Display favorites list and problem lists that might be added to it.
\item Edit favorites list.
\end{enumerate}

\newpage

\subsection{Manage Page}

\begin{center}

{\bf Manage Page Files}

\begin{tabular}{lllll}
\TT{projects/PROJECT/PROBLEM/+priv+}   	& create  & update & read & - \\
\TT{projects/PROJECT/+priv+}    	& create  & update & read & - \\
\TT{projects/+priv+}    		& create  & update & read & - \\
\TT{projects/PROJECT/PROBLEM/+blocked+}	& create  & -      & read & delete \\
\TT{projects/PROJECT/+blocked+}    	& create  & -      & read & delete \\
\TT{accounts/AID/+lists+}    		& create  & -	   & read & - \\
\TT{accounts/AID/+lists+/+favorites+}  	& create  & -	   & read & - \\
\TT{projects/PROJECT/PROBLEM/+actions+} & create  & append & -    & - \\
\TT{projects/PROJECT/+actions+}    	& create  & append & -    & - \\
\TT{accounts/AID/+actions+}    		& create  & append & -    & - \\
\TT{accounts/AID/PROBLEM/\ldots}    	& -	  & -	   & read & - \\
\TT{projects/PROJECT/PROBLEM/\ldots}    & -	  & -	   & read & - \\
\TT{projects/PROJECT/\ldots}    	& -	  & -	   & read & - \\
\TT{accounts/AID/+download-UID+}	& create  & -      & -    & - \\
\end{tabular}


\end{center}

\subsubsection{Manage Page File Formats}

\begin{indpar}
\begin{itemlist}
\item[\TT{projects/+priv+}:]
\item[\TT{projects/PROJECT/+priv+}:]\vspace*{-1ex}~
\item[\TT{projects/PROJECT/PROBLEM/+priv+}:]\vspace*{-1ex}~
\label{PRIV} \\
See Help Page, `privilege files'.
\item[\TT{projects/PROJECT/+blocked+}:]
\item[\TT{projects/PROJECT/PROBLEM/+blocked+}:]\vspace*{-1ex}~
\label{BLOCKED} \\
ASCII text containing one or more lines explaining why the
problem or project is blocked.
\item[\TT{accounts/AID/+lists+}:]
\item[\TT{accounts/AID/+lists+/+favorites+}:]\vspace*{-1ex}~ \\
See \pagref{FAVORITES}.
\item[\TT{projects/PROJECT/PROBLEM/+actions+}:]
\item[\TT{projects/PROJECT/+actions+}:]\vspace*{-1ex}
\item[\TT{accounts/AID/+actions+}:]\vspace*{-1ex}~ \\
See \pagref{ACCOUNT-ACTIONS}.
\item[\TT{projects/PROJECT/PROBLEM/\ldots}:]
\item[\TT{projects/PROJECT/\ldots}:]\vspace*{-1ex}
\item[\TT{accounts/AID/PROBLEM/\ldots}:]\vspace*{-1ex} ~ \\
The Manage page can download these directories as {\tt .tgz} files.
\item[\TT{accounts/AID/+download-UID+}] \\
When downloading a directory, the {\tt .tgz} file is stored
here and passed to the Look Page.

\end{itemlist}
\end{indpar}

\subsubsection{Manage Page Transactions}

\begin{enumerate}
\item Display project and project problem privileges ({\tt +priv+} files).
\item Edit project and project problem privileges ({\tt +priv+} files).
\item Download {\tt .tgz} files containing problem or project directories.
\item Move or copy problems to other projects.  Update previous copies.
\item Move or copy projects.  Update previous copies.
\item Block problems or projects.
\end{enumerate}

To move a problem or project, the problem or project is copied
and then the source is blocked.  The source is \underline{not}
deleted or modified in any other way.

\newpage

\subsection{View Page}

\begin{center}

{\bf View Page Files}

\begin{tabular}{lllll}
\TT{admin/+actions+}    		& -       & -      & read & - \\
\TT{admin/users/UID/+actions+} 		& -       & -      & read & - \\
\TT{admin/teams/TID/+actions+} 		& -       & -      & read & - \\
\TT{accounts/AID/+actions+}    		& -       & -      & read & - \\
\TT{accounts/AID/PROBLEM/+actions+}	& -       & -      & read & - \\
\TT{accounts/AID/+lists+/+actions+}	& -       & -      & read & - \\
\TT{projects/PROJECT/+actions+}    	& -       & -      & read & - \\
\TT{projects/PROJECT/PROBLEM/+actions+} & -       & -      & read & - \\
\end{tabular}


\end{center}

\subsubsection{View Page File Formats}

\begin{indpar}
See Account Actions, \pagref{ACCOUNT-ACTIONS}, and
administrative action files, \pagref{ADMIN/XXXX/XID/ACTIONS}.
\end{indpar}

\subsubsection{View Page Transactions}

\begin{enumerate}
\item Display action lists ({\tt +actions+} files).
\end{enumerate}

\newpage

\subsection{Template Page}

\begin{center}

{\bf Template Page Files}

\begin{tabular}{l@{\hspace{0.5in}}llll}
\TT{template/\ldots.tmpl}    		& -       & -      & read & - \\
\end{tabular}


\end{center}

\subsubsection{Template Page File Formats}

\begin{indpar}
See Job Templates \pagref{JOB-TEMPLATES}.
\end{indpar}

\subsubsection{Template Page Transactions}

\begin{enumerate}
\item Display job template files.
\end{enumerate}

\newpage

\subsection{Show Page}

\begin{center}

{\bf Show Page Files}

\begin{tabular}{l@{\hspace{0.5in}}llll}
\TT{accounts/AID/PROBLEM/PROBLEM.pdf}  	& -       & -      & read & - \\
\TT{projects/PROJECT/PROBLEM.pdf}  	& -       & -      & read & - \\
\end{tabular}


\end{center}

\subsubsection{Show Page File Formats}

\begin{indpar}
PDF files containing a problem description.
\end{indpar}

\subsubsection{Show Page Transactions}

\begin{enumerate}
\item Display or download a PROBLEM.pdf file.
\end{enumerate}

\newpage

\subsection{Look Page}

\begin{center}

{\bf Look Page Files}

\begin{tabular}{l@{\hspace{0.5in}}llll}
\TT{accounts/AID/PROBLEM/\ldots}  		& -       & -      & read & - \\
\TT{accounts/AID/PROBLEM/+work+/\ldots}  	& -       & -      & read & - \\
\TT{accounts/AID/PROBLEM/+run+/\ldots}  	& -       & -      & read & - \\
\TT{accounts/AID/PROBLEM/+parent+/{\ldots}.run}	& -       & -      & read & - \\
\TT{downloads/{\ldots}}				& -       & -      & read & - \\
\TT{documents/{\ldots}}				& -       & -      & read & - \\
\TT{accounts/AID/+download-UID+}		& -       & -      & read & - \\
\end{tabular}


\end{center}

\subsubsection{Look Page File Formats}

\begin{indpar}
{\tt +download-UID+} files can be in any format, and are downloaded
as is.  Packed tar format ({\tt .tgz}) is common.

{\tt .pdf} files are in PDF format.

Other files are sequences of UTF-8 lines to be shown or downloaded.
\end{indpar}

\subsubsection{Look Page Transactions}

\begin{enumerate}
\item Display or download a file.  UTF-8 files are displayed with
line numbers.
\end{enumerate}

\end{document}
