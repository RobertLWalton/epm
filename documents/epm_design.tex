% Educational Problem Manager (EPM) Design Manual.
%
% File:         epm_design.tex
% Author:       Bob Walton (walton@acm.org)
% Date:		See \date below.

% The authors have placed EPM (its files and the
% content of these files) in the public domain; they
% make no warranty and accept no liability for EPM.
  
\documentclass[12pt]{article}

\usepackage[T1]{fontenc}
\usepackage{lmodern}
\usepackage{makeidx}

\makeindex

\setlength{\oddsidemargin}{0in}
\setlength{\evensidemargin}{0in}
\setlength{\textwidth}{6.5in}
\setlength{\textheight}{8.5in}
\raggedbottom

\setlength{\unitlength}{1in}

\pagestyle{headings}
\setlength{\parindent}{0.0in}
\setlength{\parskip}{1ex}

\setcounter{secnumdepth}{5}
\setcounter{tocdepth}{5}
\newcommand{\subsubsubsection}[1]{\paragraph[#1]{#1.}}
\newcommand{\subsubsubsubsection}[1]{\subparagraph[#1]{#1.}}

% Begin \tableofcontents surgery.

\newcount\AtCatcode
\AtCatcode=\catcode`@
\catcode `@=11	% @ is now a letter

\renewcommand{\contentsname}{}
\renewcommand\l@section{\@dottedtocline{1}{0.1em}{1.4em}}
\renewcommand\l@table{\@dottedtocline{1}{0.1em}{1.4em}}
\renewcommand\tableofcontents{%
    \begin{list}{}%
	     {\setlength{\itemsep}{0in}%
	      \setlength{\topsep}{0in}%
	      \setlength{\parsep}{1ex}%
	      \setlength{\labelwidth}{0in}%
	      \setlength{\baselineskip}{1.5ex}%
	      \setlength{\leftmargin}{0.8in}%
	      \setlength{\rightmargin}{0.8in}}%
    \item\@starttoc{toc}%
    \end{list}}
\renewcommand\listoftables{%
    \begin{list}{}%
	     {\setlength{\itemsep}{0in}%
	      \setlength{\topsep}{0in}%
	      \setlength{\parsep}{1ex}%
	      \setlength{\labelwidth}{0in}%
	      \setlength{\baselineskip}{1.5ex}%
	      \setlength{\leftmargin}{1.0in}%
	      \setlength{\rightmargin}{1.0in}%
	      }%
    \item\@starttoc{lot}%
    \end{list}}

\catcode `@=\AtCatcode	% @ is now restored

% End \tableofcontents surgery.

\newenvironment{indpar}[1][0.4in]%
	{\begin{list}{}%
		     {\setlength{\itemsep}{0in}%
		      \setlength{\topsep}{0in}%
		      \setlength{\parsep}{1ex}%
		      \setlength{\labelwidth}{#1}%
		      \setlength{\leftmargin}{#1}%
		      \addtolength{\leftmargin}{\labelsep}}%
	 \item}%
	{\end{list}}

\newenvironment{itemlist}[1][0.2in]%
	{\begin{list}{}{\setlength{\labelwidth}{#1}%
		        \setlength{\leftmargin}{\labelwidth}%
		        \addtolength{\leftmargin}{+0.2in}%
		        \addtolength{\linewidth}{-\labelwidth}%
		        \addtolength{\linewidth}{-0.2in}%
		        \renewcommand{\makelabel}[1]{##1\hfill}}
	 \raggedright}%
	{\end{list}}

\newcommand{\TT}[1]{{\tt \bfseries #1}}
\newcommand{\key}[1]{{\bf \em #1}}
\newcommand{\EOL}{\penalty \exhyphenpenalty}
\newcommand{\pagref}[1]{p\pageref{#1}}
\newcommand{\sref}[2]{(\ref{#1}.\ref{#2})}
\newcommand{\FSTACK}[2]{{\tt \bfseries
    #1\begin{tabular}[t]{@{}l@{}}#2\end{tabular}}}
\newcommand{\STACK}[1]{\begin{tabular}[t]{@{}l@{}}
                        #1\end{tabular}}

\newcommand{\ITEM}{\hspace*{-0.2in}}
\newcommand{\TTITEM}[1]{\hspace*{-0.2in}{\TT{#1}}\\}
\newcommand{\BFITEM}[1]{\hspace*{-0.2in}{{\bf #1}}\\}

\newcommand{\STAR}{{\Large $^\star$}}
\newcommand{\PLUS}[1][]{{$^{+#1}$}}
\newcommand{\QMARK}{{$^{\,\mbox{\footnotesize ?}}$}}

\begin{document}
        
\title{Educational Problem Manager\\
Design Manual}

\author{Robert L. Walton}

\date{September 15, 2020}
 
\maketitle

\begin{center}
{\large \bf Notice}
\\[2ex]
\begin{minipage}{5.5in}
The authors have placed EPM (its files and the content of these files) in
the public domain; they make no warranty and accept
no liability for EPM.
\end{minipage}
\end{center}
\begin{center}
\large \bf Table of Contents
\end{center}

\bigskip

\tableofcontents 

\newpage

\section{Introduction}

This document gives design information for EPM system maintainers.
This document supplements but does not reiterate
documentation in the EPM Help Page for
users.  Comments in code files in turn supplement but do not, with
the exception of parameters files,
reiterate this document or the Help Page.

Instructions for setting up an EPM server are in the file
\begin{center}
{\tt include/maintenance\_parameters.php}
\end{center}

\section{Definitions and Rules}

\subsection{Names}\label{NAMES}

\begin{enumerate}
\item \key{User chosen names}\label{USER-CHOSEN-NAME}
consists of letters, digits,
dash({\tt -}), and underscore({\tt \_}), begin with a letter,
and end with a letter or digit.
See {\tt /include/parameters.php} {\tt \$epm\_name\_re}.
\item \key{Visible file names} have basenames that
consist of letters, digits, dash({\tt -}), and
underscore({\tt \_}), begin with a letter or digit, and end
with a letter or digit, and optional extensions that obey
same rules.  See {\tt /include/parameters.php} {\tt \$epm\_filename\_re}.
\item \key{Visible problem file names} have basenames that end with the
      problem name, which may optionally be preceded by a dash({\tt -}) but
      not by any other character.
\item Invisible problem
      file and directory names begin and end with plus({\tt +}).
\item Administrative files may follow other rules.  In particular,
      email addresses have a file with a name that is the URL encoded email
      address, and browser tickets have a file with a name that is the
      32 hex digit ticket itself.
\item \key{User IDs} and \key{team IDs}\label{AIDS} are user chosen names.
      An \key{account ID} is either a user ID or a team ID.
\item \key{E-mail addresses} may \underline{not} have the
      characters {\tt <}, {\tt >}, {\tt "}, {\tt :}, or space
      characters.
\item A \key{login name} is either an e-mail address, or an
      account ID followed by a {\tt :} followed by an e-mail address.
\end{enumerate}

\subsection{Times}

\begin{enumerate}
\item Times are formatted as per {\tt /include/parameters.php}
     which:
     \begin{itemize}
     \item defines {\tt \$epm\_time\_\EOL format}
           (defaults to {\tt "\%FT\%T\%Z"}, which
	    produces times such as {\tt 2020-09-15T07:40:10EDT})
     \item sets the time zone using
           {\tt date\_default\_\EOL timezone\_\EOL set}
     \end{itemize}

\end{enumerate}

\subsection{Account IDs}

\begin{enumerate}
\item \key{Account IDs}
      (AIDs) are user chosen names \sref{NAMES}{USER-CHOSEN-NAME}).
      They are unique to the
      account and used for both external and internal identification.
      Once assigned, they cannot be changed.
\item There are two kinds of AIDs: \key{user UIDs} for individual users,
      and \key{team TIDs} for teams \sref{NAMES}{AIDS}.
\end{enumerate}

\subsection{Random IDs}

\begin{enumerate}
\item A \key{random ID} is a 32 hexadecimal digit number, or equivalently
      a 128-bit number.  Several are generated from /dev/random
      the first time the server is used, and thereafter they
      are generated as a pseudo-random sequence using previously
      generated values to aes-128-cbc encrypt previous values.
      See {\tt /include/epm\_random.php}.
\item Browser TICKETS are random IDs.
\item The \key{\$ID} variable is a random ID used to validate
      both POST and GET requests from pages.
      
      For each tab, and
      sometimes for the view window, the first GET for the tab
      or window generates the first \$ID value for the pages
      that will occupy the tab or window, and also generates
      a random key that is used to generate a sequence
      of \$ID values for the tab or window by encrypting
      each \$ID to generate the next \$ID.  Thereafter each
      request is checked to see if it has the right \$ID value,
      and a new \$ID value is generated for the next tab or
      window contents.

      \$ID values are generated and checked by {\tt /page/index.php}
      which is required by all page .php files
      \sref{TABS-AND-WINDOWS}{SEQUENCE-RULE}.
\end{enumerate}

\subsection{Tabs and Windows}
\label{TABS-AND-WINDOWS}

\begin{enumerate}
\item Transactions that make changes to the server files
are executed in tabs.
The \key{main tab} is for non-problem specific
transactions.  For each account problem there is a
\key{problem tab} for transactions on that problem.

Popup windows are used to display information about server files,
without making any changes.  The \key{help window} displays help and
guide information.  The \key{documents index} and
\key{downloads index} windows display indices of
available documents and downloads.  The \key{auxiliary window}
displays files and other information.  Pages that are loaded into
the auxiliary window by default can be loaded into floating windows
instead (just by holding down an ALT key when launching the window):
each floating window is separarate and specific to its content.

\item Pages are assigned to tabs or windows.  The Login, Logout,
Project, User, Manage, List Edit, and Favorites Edit Pages are assigned
to the main tab;
Problem, Option, and Run Pages are assigned to problem tabs;
the View and Template Pages are assigned to the auxiliary
window; the Documents Page is assigned to the documents index window;
the Downloads Page is assigned to the downloads index window;
and Help and Guide Pages are assigned to the help pop-up
window.

\item \key{Page Rule}\label{PAGE-RULE}
At any given time a tab or window has a current page.
A GET can change the current page.  All
transactions done with POSTs
are checked to be sure their page is the current page for
its the tab or window type.  So, for example,
if you have just done a GET to the Project Page,
you cannot POST to the User Page.  Or if you have
just done a GET to the Option Page with problem=PPPP,
you cannot do a POST to the Problem Page with problem=PPPP.

This rule is checked by {\tt index.php} which is required
at the beginning of all pages in tabs or windows that
access the server state.

\item \key{Sequence Rule}\label{SEQUENCE-RULE}
Transactions within a tab are sequenced, so that
if a transaction is out of sequence the tab becomes
\key{orphaned} and must be closed.
Sequencing prevents two main
tabs from existing at the same time, or two problem tabs
for the same problem existing at the same time.

Sequencing is done
by random sequence \$IDs that are attached to each page.
The next request must contain the current \$ID else the
tab is orphaned.  For the main tab the Login Page initializes
the tab's \$ID sequence.  For problem tabs the Problem Page
initializes the sequence.  For the view window, the View Page
initiates and uses sequencing, but other view window pages are
no-post pages that do no sequencing.  The help window pages are
{\tt .html} pages that do no sequencing.

This rule is checked by {\tt index.php} which is required
at the beginning of all pages in tabs or windows that
access the server state.

\item \key{Stateless Pages}\label{STATELESS-PAGES}
The Help Page, Guide Page, and Downloads Page are stateless.
They access just read-only files in the Home Directory
\sref{DIRECTORIES}{H-DIRECTORY}.
\end{enumerate}

\subsection{Directories}
\label{DIRECTORIES}

\begin{enumerate}
\item There are three main directories:\label{MAIN-DIRECTORIES}

      \key{H, Home Directory}:\label{H-DIRECTORY}  This is the {\tt epm}
      directory which is loaded from {\tt github}.

      \key{W, Web Directory}\label{W-DIRECTORY}:  This is the directory
      named by the EPM server URL.  It contains a symbolic link to
      the {\tt index.php} file that is
      the first file loaded when a user initially
      contacts the EPM server.

      \key{D, Data Directory}:  This is the directory
      containing all the mutable data for the EPM server.

\item The following subdirectories of H contain the
      EPM files that are directly visible to web clients:

      \key{H/page}:  Loadable page files.  {\tt W/page} is
      symbolically linked to this directory.

      \key{H/page/downloads}:  Example files downloadable
      by the client.

\item The following subdirectories of H contain the
      EPM files that are \underline{not}
      directly visible to web clients:

      \key{H/include}:  Files that can be `{\tt require}'ed by
      loadable page files.

      \key{H/bin}:  Binary executables of programs called by
      loadable pages or used for off-line maintenance.

      \key{H/template}:  Templates used to compute client problem
      files from other client or project files.

      \key{H/doc}:  Off-line documentation files, including this file.

      \key{H/secure}:  Source code for binary executables involved with
      security.

      \key{H/src}:  Source code for binary executables \underline{not}
      involved with security.

      \key{H/setup}:  Initial contents of D, the data directory,
      during EPM server setup.

\end{enumerate}

\subsection{Page Initialization}
\label{PAGE-INITIALIZATION}

\begin{enumerate}
\item The web directory, W \sref{DIRECTORIES}{MAIN-DIRECTORIES},
     contains the following:\label{W-CONTENTS}

  \hspace*{0.2in}\begin{tabular}{l}
      symbolic link {\tt W/page} $\longrightarrow$ {\tt H/page} \\
      symbolic link {\tt W/index.php}
          $\longrightarrow$ {\tt page/index.php} \\
      {\tt W/parameters.php}, modified copy of {\tt H/include/parameters.php} \\
      {\tt W/maintenance\_parameters.php}, \\
      \hspace*{0.2in}modified copy of
           {\tt H/include/maintenance\_parameters.php}, \\
      \hspace*{0.2in}(only used off-line) \\
      \end{tabular}

\item When loaded, a page initializes by executing the following steps:
\begin{itemize}
\item Set {\tt \$epm\_page\_type} to indicate the tab or pop-up window
      or other type.  The possible values are:
      
      {\tt +main+} and {\tt +problem+} for tabs;
      
      {\tt +view+} for a view pop-up window that POSTs;
      
      {\tt +no-post+} for a view pop-up window that does \underline{not}
      POST;
      
      {\tt +download+} for pages that download files
      so that {\tt <script>}
      in {\tt /page/\EOL index.php} which implements the help button
      is surpressed (these pages do no POSTing and have
      no buttons).

\item If the page is the first loaded in a tab or popup-window that POSTs,
      then it must set {\tt \$epm\_ID\_init} to initialize a new
      \$ID sequence for the tab or popup-window.  Otherwise the page
      leaves {\tt \$epm\_ID\_init} unset.

\item The page requires {\tt /page/index.php} using:

      \hspace*{0.2in}{\tt require \_\_DIR\_\_ . '/index.php'}
      
\end{itemize}

\item \label{INDEX-ACTIONS}
      Upon being required, {\tt /page/index.php} executes the
      following in order:
\begin{itemize}
\item Compute:

      \hspace*{0.2in}\begin{tabular}{l}
		\tt \$epm\_root = ROOT \\
		\tt \$epm\_self = SELF \\
		\tt \$epm\_web = W \\
		\end{tabular}

       where the page currently being loaded has the URL

       \hspace*{0.2in}{\tt http://HOST/ROOT/SELF}

       {\tt SELF} has the form {\tt page/...}, or if
       not that, the form {\tt index.php}, HOST is the
       EPM server host name, and {\tt ROOT} is whatever
       is left over.  Here W is the EPM server web directory
       (\pagref{W-DIRECTORY}) and is

       \hspace*{0.2in}{\tt \$\_SERVER['DOCUMENT\_ROOT'] . ROOT}

\item If {\tt SELF} is either {\tt index.php} or {\tt page/index.php},
      re-routes the request to {\tt page/\EOL login.php}.  The
      request must be a 'GET' else it is not accepted.

\item Loads {\tt W/parameters.php} which in turn defines H and D
      \sref{DIRECTORIES}{MAIN-DIRECTORIES}.

\item Runs the following checks and aborts invalid requests:
\begin{itemize}
\item Checks that the client request is using the same IP
address as was used for login, unless the {\tt \$epm\_check\_ipaddr}
parameter is false.
\item Checks that the session is logged in, unless the page being
loaded is {\tt /page/\EOL login.php} or {\tt /page/user.php}.
\item Uses {\tt EPM\_ABORT} (\pagref{EPM_ABORT}) to check that
no other session has been started after this session using the
same {\tt AID:UID} login name.
\end{itemize}

\item If the session has logged in, defines:
\\[2ex]
\hspace*{0.2in}\begin{minipage}{5in}
\$aid = \$\_SESSION['EPM\_AID'] \\
\$uid = \$SESSION['EPM\_UID'] \\
\$lname = <login name> \\
\$is\_team = \$\_SESSION['EPM\_IS\_TEAM'] \\
\$rw = \begin{tabular}[t]{@{}l@{}}
       true if page is read-write; false if read-only \\
       (see {\tt page/index.php} and {\tt include/epm\_rw.php} for details)
       \end{tabular}
\end{minipage}

\item Defines functions and error handlers.

\item Except for pages of {\tt +download+} and {\tt +no-post+} type,
      checks for violations of the Page Rule (\pagref{PAGE-RULE})
      and aborts violating requests.

\item Except for pages of {\tt +download+} and {\tt +no-post+} type,
      initializes or checks the \$ID to enforce the
      Sequence Rule (\pagref{SEQUENCE-RULE}), and
      re-routes violating requests
      to the {\tt /page/orphan.html} page to declare
      the tab or window orphaned.

\item Except for pages of {\tt +download+} type and xhttp requests,
      sets up shutdown function that will write statistics
      into {\tt accounts/\EOL AID/\EOL +read-write+} or
      {\tt accounts/\EOL AID/\EOL +read-only+}.
\item Except for pages of {\tt +download+} type and xhttp requests,
      defines functions
      and parameters for use in creating buttons and launching
      widows, including {\tt <script>} functions.

\item Note that may parameters and some functions are defined in
      {\tt W/parameters.php}.  See that file.  Also see
      {\tt /page/index.php} for functions it defines and button
      parameters it defines.


\end{itemize}

\end{enumerate}

\subsection{Locking}

In EPM each request is an independent transaction.  Locking
is needed to keep two requests from interferring with each other.

Some EPM operations consist of multiple requests.  However,
only the last of these requests modifies EPM server state
(that is not in a working subdirectory dedicated to the operation).
So the strategy is to have this last request check whether
other conflicting requests happened during the operation, and
if yes, the last request aborts, does not change EPM state, and produces
an error message.

\begin{enumerate}

\item \key{Session Locking} At the beginning of each request
the PHP {\tt session\_start()} function is called.  This locks
the session file (where session data is stored).  As a consequence,
given two requests to the same session, one must complete before
the other starts.

\item \key{Atomic Files}
Some files are shared between sessions and need to be
read and written atomically, so that they maintain their
format specifications, but need no other locking:
\begin{itemize}
\item {\tt .list} files containing problem lists.  Only one
session can write such a file, but many may read it.
\item {\tt +priv+} files containing privileges.  Its possible
but rare for such a file to be writtable by several sessions if it has
multiple owners, but if these collide, `last-writter-wins' is
an acceptable implementation.  These files can have many readers.
\end{itemize}

\item \key{Tab Uniqueness}
A session is logged into a particular
account.  Each tab has a type, either `main'
or the name of a problem in the session account.
The Sequence Rule \sref{TABS-AND-WINDOWS}{SEQUENCE-RULE}
ensures that there is at most one tab of each type at a given
time.

More specifically, if a second tab of a give type is opened by
the user for the session, the second tab gets a new sequence of
\$ID numbers for the tab type, and when the first tab makes a request, its
now obsolete \$ID number is detected (by {\tt index.php}) and
the tab contents are replaced by the {\tt orphan.php} page which
announces that the tab is \key{orphaned} and should be closed.

A similar thing happens if two windows of `view' type exist
with pages that execute POSTs.  `View' windows make no changes
in the EPM file system, but do have their own session variables.

\item \key{Tab Independence}
The pages in each
tab, for the most part, operate on different data from the pages
in other tabs.  A problem tab operates mostly on its problem
directory in the account, and the `main' tab operates mostly on
everything else.  Therefore, since there is at most one tab of
each type, by Tab Uniqueness, most requests are independent
of each other.

\item \key{Administrative Locking}
Administrative files are those in the {\tt admin} directory tree.
Only the Login Page and User Page access most administrative files
These pages both begin by getting an exclusive lock on the
{\tt admin} directory using the LOCK function in {\tt parameters.php}.

Administrative files with other or extra considerations are:
\begin{itemize}
\item {\tt admin/teams/TID/+read-write+} files: These are themselves
locked by {\tt page/\EOL index.php} and {\tt include/\EOL epm\_rw.php}.
\item {\tt admin/users/UID/UID.info} files.  These are written
atomically by the User Page and read atomically by the Problem Page
in order to ensure the integrity of their format.
\end{itemize}

\item \key{Read-Write Locking}
For team member logins the {\tt admin/teams/TID/+read-write+}
file is locked at the beginning of a request.  If it is
determined that the account is currently read-only, this file
is unlocked immediately, else it is unlocked at the end of the
request.

If a read-only request attempts to become read-write, the file
is re-locked and remains locked till the end of the request.

This sequences requests from read-write team logins for the
same team, even if the requests are made by different team
members in different sessions.

\item \key{Project Problem Locking}
A project problem directory is locked using the
LOCK function in {\tt parameters.php}
during a push or pull involving the directory.
For pushing this is an exclusive lock; for pulling it is a shared
lock.

A push or pull can involve several requests:
the first to compile actions and the last to execute them
(there can be a request in between that simply presents
information stored in the session data by the first request).
If the project problem directory changes between requests,
because of a push to the directory by another user, the last
request could cause data inconsistency.  To prevent this
the exclusive LOCK time of the directory is monitored to check if some
other session has exclusively locked the directory between the
first and last requests of an operation.
If so, the last request is aborted with an error message and
does not execute.

\item \key{Local Problem Locking}
When a file is uploaded into a problem or made from another file
in the problem, a background job is executed.
Similarly when a {\tt .run} file is run, the run is a background job.
The local problem directory is not modified by a background job
until the job finished, at which time some files may be saved in
the local problem directory.

If the problem has a parent, a shared lock is
obtained on the parent using LOCK at the start of the background
job, and the LOCK time is checked at the end of the job to be sure
it has not changed.  If it has, a push to the parent was done
during the job, an error is declared for the job,
and the job results are not saved in the problem local directory.


Pulls to a local problem directory an be run in the `main' tab
while a background job is run in the local problem directory in
its problem tab.  To prevent conflict, every time the problem
directory is altered its {\tt +altered+} file is touched.
The modification time of this is checked to detect conflicts
and abort either the execution request for a pull or the
finishing of an otherwise sucessful background job.
Local problem directories can be altered when a background
job keeps files, when the Problem Page deletes files, or when
the Project Page pulls to the local problem.


\end{enumerate}


\subsection{Security}

There are two ways to breach an EPM server:

\begin{itemize}

\item \key{Session Hi-Jacking} ~ The session is identified
by the cookie which is a random number.  To hi-jack a session,
the hacker must intercept the cookie.  A good way to 
protect against this is to get a certificate for the EPM
server so the server uses https.

As alternate protection, the {\tt parameters.php} file
contains a parameter which if set will cause the session
to insist that all requests made to it come from the same
IP address.  This might cause problems for legitimate mobile browsers,
but should prevent session hi-jacking.

\item \key{Illegal Requesting} ~ Since it is easy to get a user
account on an EPM server, a user can try to breach the server by issuing
an illegal request from a legitimate session.  Therefore each
request must be checked to be sure it is legal.  If not,
an exit with 'UNACCEPTABLE HTTP ...' message is executed.

An EPM session is definitely \underline{not} stateless.
Not only is there session state, such as the current
user logged into the session, but there is state in the
EPM server data file system.

The Page Rule \sref{TABS-AND-WINDOWS}{PAGE-RULE}
and Sequence Rule \sref{TABS-AND-WINDOWS}{SEQUENCE-RULE}
work together to ensure that a page POSTed to will be
be the same page loaded by the last GET to the tab or
window doing the POST.  This simplifies request checking.

Request checking is just about checking the request type and
request parameters to ensure that the request is legal given the
current state of the server.

\end{itemize}

\section{Data Files}

[xxx] means file modification time is read by xxx

\begin{center}
\small
\begin{tabular}{|l|l|l|l|l|l|}
\hline
Name & Format & Description & Creators & Updaters & Readers \\
\hline\hline
\TT{error.log} & lines & error log \pagref{ERROR.LOG}
	& (all) & (all) &  \\ 
\hline
\TT{debug.log} & lines & debugging log \pagref{DEBUG.LOG}
	& (all) & (all) &  \\ 
\hline
\TT{admin} & dir & \STACK{administrative\\files}
	& login & \STACK{login\\user} & \STACK{index\\login\\user} \\ 
\hline
\TT{admin/+blocking+} & dir
        & \STACK{email blocking\\control file \pagref{ADMIN/BLOCKING}}
	& (editor) & (editor ) & login \\ 
\hline
\TT{admin/motd.html} & html
        & \STACK{message\\of the day \pagref{ADMIN/MOTD}}
	& (editor) & (editor ) & login \\ 
\hline
\TT{admin/+lock+} & time
        & \STACK{administrative\\lock file \pagref{ADMIN/LOCK}}
	& (updaters) & \STACK{login\\user} & (updaters) \\ 
\hline
\TT{admin/+random+} & binary
        & \STACK{random number\\data \pagref{ADMIN/RANDOM}}
	& login & \STACK{login\\index} & \STACK{login\\index} \\ 
\hline
\TT{admin/+actions+} & lines &
        \STACK{log of\\administrative\\actions \pagref{ADMIN/XXXX/XID/ACTIONS}}
	& (updaters) & user & view \\ 
\hline
\TT{admin/browser} & dir & \STACK{browser\\tickets}
	& login & login & login \\ 
\hline
\TT{admin/browser/TICKET} & 1-line
        & ticket info \pagref{ADMIN/TICKET/TICKET}
	& login & & login \\ 
\hline
\TT{admin/email} & dir & email files
	& user & user & \STACK{login\\user} \\ 
\hline
\TT{admin/email/EMAIL} & 1-line
        & email info \pagref{ADMIN/EMAIL/EMAIL}
	& user & \STACK{login\\user} & \STACK{login\\user} \\ 
\hline
\TT{\STACK{admin/users\\admin/teams}}
        & dir & \STACK{administrative\\user/team\\directories}
	& user & user & \STACK{user\\login} \\ 
\hline
\TT{\STACK{admin/users/UID\\admin/teams/TID}}
        & dir & \STACK{administrative\\account files}
	& user & user & \STACK{user\\login} \\ 
\hline
\STACK{
\FSTACK{admin/}{users/UID/\\UID.login}\\
\FSTACK{admin/}{teams/TID/\\UID.login}}
        & lines
        & \STACK{log of logins\\\pagref{ADMIN/USERS/XID/YID.LOGIN}}
	& (updaters) & \STACK{login\\user} & [index]  \\ 
\hline
\STACK{
\FSTACK{admin/}{users/UID/\\UID.inactive}\\
\FSTACK{admin/}{teams/TID/\\UID.inactive}}
        & lines
	& \STACK{inactive\\.login files \pagref{ADMIN/USERS/XID/YID.INACTIVE}}
	& user & & \\ 
\hline
\FSTACK{admin/}{users/UID/\\UID.info} & json
	& user info \pagref{ADMIN/USERS/UID/UID.INFO}
	& user & user & \STACK{user\\problem} \\ 
\hline
\FSTACK{admin/}{teams/TID/\\TID.info} & json
	& team info \pagref{ADMIN/USERS/TID/TID.INFO}
	& user & user & user \\ 
\hline
\end{tabular}
\end{center}

\begin{center}
\small
\begin{tabular}{|l|l|l|l|l|l|}
\hline
Name & Format & Description & Creators & Updaters & Readers \\
\hline\hline
\STACK{
\FSTACK{admin/}{users/UID/\\+actions+}\\
\FSTACK{admin/}{teams/TID/\\+actions+}}
        & lines
        & \STACK{log of accounts's\\administrative\\
	         actions \pagref{ADMIN/XXXX/XID/ACTIONS}}
	& (updaters) & user & view \\ 
\hline
\FSTACK{admin/}{users/UID/\\manager}
    & 1-line & \STACK{teams that UID\\manages \pagref{ADMIN/USERS/UID/MANAGER}}
    & user & user & user \\ 
\hline
\FSTACK{admin/}{users/UID/\\member}
    & 1-line & \STACK{teams of which\\UID is a
                                    \\member \pagref{ADMIN/USERS/UID/MEMBER}}
    & user & user & user \\ 
\hline
\FSTACK{admi}{n/teams/TID/\\+rw+}
    & UID & \STACK{current\\read-write
                          \\user \pagref{ADMIN/TEAMS/TID/RW}}
    & +main+ & +main+ & \STACK{+main+\\index} \\ 
\hline
\TT{accounts} & dir & \STACK{holds account\\subdirectories}
              & user & user & all \\ 
\hline
\TT{accounts/AID} & dir & \STACK{account\\subdirectory}
	& user & \STACK{problem\\project} & all \\ 
\hline
\FSTACK{accoun}{ts/AID/\\+lists+}
        & dir & \STACK{holds account\\problem lists}
	& list & \STACK{list\\favorites} & \STACK{+main+\\view} \\ 
\hline
\FSTACK{accoun}{ts/AID/\\+actions+}
        & lines & \STACK{log of account\\problem\\related\\actions}
	& (updaters) & \STACK{project\\run} & view \\ 
\hline
\FSTACK{accoun}{ts/AID/\\+read-write+}
        & lines & \STACK{log of account\\read-write mode\\requests
	          \pagref{ACCOUNTS/AID/READ-WRITE}}
	& index & index & [+main+] \\ 
\hline
\FSTACK{accoun}{ts/AID/\\+read-only+}
        & lines & \STACK{log of account\\read-only mode\\requests
	          \pagref{ACCOUNTS/AID/READ-ONLY}}
	& index & index & [+main+] \\ 
\hline
\FSTACK{accou}{nts/AID/\\PROBLEM}
        & dir & \STACK{account\\problem\\directory}
	& project & \STACK{+problem+\\project} & \STACK{+problem+\\project} \\ 
\hline
\FSTACK{accou}{nts/AID/\\PROBLEM/\\+actions+}
        & lines & \STACK{log of\\problem\\related\\actions}
	& (updaters) & \STACK{project\\run} & view \\ 
\hline
\FSTACK{accou}{nts/AID/\\PROBLEM/\\+altered+}
        & empty & \STACK{alteration\\indicator \pagref{PROBLEM/ALTERED}}
	& (updaters) & \STACK{problem\\run} & [updaters] \\ 
\hline
\FSTACK{accou}{nts/AID/\\PROBLEM/\\+changes+}
        & lines & \STACK{log of changes\\made by pulls}
	& project & project & \\ 
\hline
\end{tabular}
\end{center}

\begin{center}
\small
\begin{tabular}{|l|l|l|l|l|l|}
\hline
Name & Format & Description & Creators & Updaters & Readers \\
\hline\hline
\FSTACK{accou}{nts/AID/\\PROBLEM/\\+work+}
        & dir & \STACK{working\\directory\\for jobs}
	& \STACK{problem\\run}
	& \STACK{problem\\run}
	& \STACK{problem\\run} \\ 
\hline
\FSTACK{accou}{nts/AID/\\PROBLEM/\\+run+}
        & dir & \STACK{working\\directory\\for runs}
	& run & run & run \\
\hline
\FSTACK{accou}{nts/AID/\\PROBLEM/\\\ldots}
        & various & \STACK{files visible\\to users}
	& +problem+ & +problem+ & +problem+ \\
\hline
\TT{projects} & dir & \pagref{PROJECTS} & login & maint & \\ 
\hline
\TT{lists} & dir & \STACK{links to\\published\\lists} & list & list
           & \STACK{favorites\\list\\project\\view\\manage} \\ 
\hline
\TT{default} & dir & \STACK{default\\program\\binaries} & setup &  & \\ 
\hline
\TT{+web-save+} & dir & backup of W & backup & backup & backup \\ 
\hline
\TT{+web+} & link & link to W & setup &  & \\ 
\hline
\hline
\end{tabular}
\\[1ex]
setup is setup function of epm/bin/epm \\
backup is backup function of epm/bin/epm \\
\end{center}

\section{Session Variables}

\begin{center}
\begin{tabular}{|l|l|l|l|l|l|}
\hline
Name & Description & Creators & Updaters & Readers \\
\hline\hline
\TT{EPM\_EMAIL} & \STACK{login email}
                & login & & all pages \\ 
\hline
\TT{EPM\_AID} & account ID & \STACK{login\\user} & & all pages \\ 
\hline
\TT{EPM\_UID} & user ID
              & \STACK{login\\user} & & \STACK{login\\user\\manage} \\ 
\hline
\TT{EPM\_IS\_TEAM} & \STACK{true iff AID\\is team ID}
                   & \STACK{login\\user} & & index \\ 
\hline
\TT{EPM\_PAGE[id\_type]} & \STACK{current\\session\\page}
                 & index & index & index \\ 
\hline
\TT{EPM\_IPADDR} & \STACK{session\\IP address}
                 & login & & \STACK{index\\login\\user} \\ 
\hline
\TT{EPM\_TIME} & \STACK{session\\time}
                 & login & & \STACK{index\\login\\user} \\ 
\hline
\TT{EPM\_ID\_GEN} & \$ID generation
                 & index & index & index  \\ 
\hline
\TT{EPM\_ABORT} & \STACK{session\\abort info}
                 & \STACK{login\\user} & & index \\ 
\hline
\end{tabular}
\end{center}

\begin{center}
\begin{tabular}{|l|l|l|l|l|l|}
\hline
Name & Description & Creators & Updaters & Readers \\
\hline\hline
\TT{EPM\_MAIN} & \STACK{temporary\\data for\\current\\+main+\\page}
                & \STACK{project\\user\\list\\favorites\\manage}
		& (creators) & (creators) \\ 
\hline
\TT{EPM\_PROJECT} & \STACK{permanent\\data for\\project}
                & project & project & project \\
\hline
\TT{EPM\_USER} & \STACK{permanent\\data for\\user}
                & user & user & user \\
\hline
\TT{EPM\_MANAGE} & \STACK{permanent\\data for\\manage}
                & manage & manage & manage \\
\hline
\TT{EPM\_VIEW} & \STACK{permanent\\data for\\view}
                & view & view & view \\
\hline
\TT{EPM\_PROBLEM[problem]} & \STACK{permanent\\data for\\problem}
                & problem & problem & problem \\
\hline
\TT{EPM\_WORK[problem]} & \STACK{data for\\current\\background\\task}
                & problem & problem & problem \\
\hline
\TT{EPM\_RUN[problem]} & \STACK{data for\\current\\background\\run}
                & run & run & run \\
\hline
\end{tabular}
\end{center}

\newpage

\section{Web Pages}

\subsection{Index Page}

The Index Page is required by every other EPM .php page
does initial setup for all EPM .php pages.  It also
functions as the initial file for accessing the EPM
server and reroutes these accesses to the login page.

\begin{center}
{\bf Index Page Requires}
\\[1ex]
\begin{tabular}{ll}
\TT{include/parameters.php} \\
\TT{include/epm\_abort.php} & only if aborting \\
\TT{include/epm\_random.php} & only for 'GET's to pages setting
                               \$epm\_ID\_init \\
\end{tabular}
\\[3ex]
{\bf Index Page Files}
\\[1ex]
\begin{tabular}{lllll}
\TT{error.log}			& create  & append & - \\
\TT{debug.log}			& -  & - & - \\
\TT{admin/teams/AID/+rw+}       & create  & lock   & read \\
\TT{accounts/AID/+read-write+}  & create  & append & - \\
\TT{accounts/AID/+read-only+}   & create  & append & - \\
\end{tabular}
\\[3ex]
{\bf Index Page Session Data}
\\[1ex]
\begin{tabular}{lllll}
\TT{EPM\_IPADDR}	& -  & -      & read \\
\TT{EPM\_AID}		& -  & -      & read \\
\TT{EPM\_UID}		& -  & -      & read \\
\TT{EPM\_EMAIL}		& -  & -      & read \\
\TT{EPM\_IS\_TEAM}	& -  & -      & read \\
\TT{EPM\_ABORT}		& -  & -      & read \\
\TT{EPM\_TIME}		& -  & -      & read \\
\TT{EPM\_PAGE[\$id\_type$^*$]}	& create  & update  & read \\
\TT{EPM\_ID\_GEN[\$id\_type$^*$]}	& create  & update  & read \\
\end{tabular}
\\[1ex]
$^*$ \$id\_type is "+main+" for main tab page,\\
PROBLEM name for problem tab page, and \\
"+view+" for view window page
\\[3ex]
{\bf Index Page Global Data}
\end{center}

The following are global variables set just before index.php
is required by another page.

\begin{center}
\begin{tabular}{lp{4.5in}}
\TT{\$epm\_page\_type}	& One of: \begin{tabular}[t]{ll}
                          +main+ & main tab page \\
			  +problem+ & some problem tab page \\
			  +view+ & view window page \\
			  +no-post+ & view window page that \\
			            & does no POSTs \\
			  +download+ & page that just downloads a file \\
			  \end{tabular}
\\[0.5ex]
\TT{\$epm\_ID\_init}	& If set re-initializes \$ID generator;
                          see \$ID below. \\
\end{tabular}
\end{center}

The following are global variables defined by index.php when it is
required at the beginning of an EPM .php page, and usable
by the remainder of that page.  For other such parameters,
see the include/parameters.php file.

\begin{center}
\begin{tabular}{lp{4.0in}}
\TT{\$epm\_method}	& the request method,
                          either 'GET' or 'POST' \\
\STACK{\TT{\$epm\_root}\\\TT{\$epm\_self}}
    & ROOT and SELF, where the URL used to access a page is HOST/ROOT/SELF
      and SELF either has the form /page/... or the form /index.php \\
\TT{\$epm\_web}	& the EPM web directory W \sref{DIRECTORIES}{MAIN-DIRECTORIES}
			\\
\TT{\$rw}	& true if request is being processed in read-write mode;
                  false if in read-only mode \\
\TT{\$aid}	& AID (\$\_SESSION['EPM\_AID']) if set \\
\TT{\$uid}	& UID (\$\_SESSION['EPM\_UID']) if set \\
\TT{\$lname}	& login name, either AID if AID == UID, or AID:EMAIL
                  if AID != UID \\
\TT{\$is\_team}	& true iff AID is a team ID so login is a team member login
		  (\$\_SESSION['EPM\_IS\_TEAM']) \\
\TT{\$ID}	& the identifier which must be presented by the next
                  request (as ?id=\$ID) unless the next page requested
		  sets \$epm\_ID\_init; see EPM\_ID\_GEN on
		  \pagref{EPM_ID_GEN} \\
\TT{\$data}	& same as \$\_SESSION['EPM\_PAGE'][\$id\_type];
                  used for per tab or view window data:
		  see \pagref{EPM_PAGE} \\
\TT{\$state}	& same as \$data['STATE']; set to 'normal'
                  by index.php on 'GET'
\end{tabular}

\end{center}

\subsubsection{Index Page File Formats}

\begin{indpar}
\begin{itemlist}
\item[\TT{error.log}:]~
\label{ERROR.LOG} \\
Records all PHP error messages that would normally
be in the HTTP server log, including messages generated
by the ERROR and WARN functions (see index.php).

Contains lines of format:%
\hspace{0.2in}CLASS ERRNO SELF AID (TIME)

followed by a stack trace.  Here
\begin{tabular}[t]{@{\hspace{0.2in}}lp{3.9in}}
CLASS & \small \{USER,EPM,SYSTEM\}\_\{WARNING,NOTICE,ERROR\} \\
ERRNO & PHP error number \\
SELF  & page name relative to W (EPM\_SELF)\\
AID   & account ID, or EMAIL if account ID not available \\
TIME  & session time (EPM\_TIME), if available
\end{tabular}

\item[\TT{debug.log}:]~
\label{DEBUG.LOG} \\
Contains lines output by the DEBUG function in parameters.php.
Not actually specific to index.php or any page.
See \$epm\_debug and the DEBUG function in parameters.php.

\item[\TT{admin/teams/AID/+rw+}:] See \pagref{ADMIN/TEAMS/TID/RW}

\item[\TT{accounts/AID/+read-only+}:]
\item[\TT{accounts/AID/+read-write+}:]\vspace*{-1ex}~
\label{ACCOUNTS/AID/READ-ONLY}
\label{ACCOUNTS/AID/READ-WRITE} \\
One line is appended at the end of each http request, of
the form:\\
\hspace*{0.5in}BEGIN-TIME END-TIME SELF AID UID
\\
where
\begin{tabular}[t]{@{\hspace{0.2in}}lp{3.7in}}
BEGIN-TIME & request processing start time in seconds \\
END-TIME & request processing end time in seconds \\
SELF  & page name relative to W (EPM\_SELF)\\
AID   & account ID \\
UID   & user ID \\
\end{tabular}
\\[1ex]
Times are typically to the nearest microsecond.
\\[1ex]
The +read-write+ file is written if the request is
read-write at its end, or the +read-only+ file is
written if the request is read-only.  The modification
time of the +read-write+ file is used to determine the
last time the account made a read-write request.

Download and xhttp requests are not recorded.


\end{itemlist}
\end{indpar}

\subsubsection{Index Page Session Variables}

\begin{indpar}[0.2in]
In the following \$id\_type is \$epm\_page\_type
when the latter is '+main+' or '+view+' and the problem
name when the latter is '+problem+'.
\begin{itemlist}
\item[\TT{EPM\_PAGE[\$id\_type]}:]~
\label{EPM_PAGE} \\
      Data specific to a particular tab or to the view
      window.  Same as \TT{\$data} global variable.
      Re-initialized on a 'GET' by index.php to:

      \centerline{ ['SELF' => \$epm\_self, 'STATE' => 'normal'] }

      Checked by index.php for 'POST's to be sure they target the
      page of the last 'GET' for the given \$id\_type.

\item[\TT{EPM\_ID\_GEN[\$id\_type]}:]~
\label{EPM_ID_GEN} \\
      The list [VALUE, KEY, IV] used to generate \$ID
      values.  The next \$ID value is VALUE.  When it
      is set, a new VALUE is generated by encrypting the
      old VALUE by KEY with IV as
      the initialization vector (it is always 0 and
      is included here as an optimization).
      Re-initialized for pages that set \$epm\_ID\_init;
      checked for other pages of \$epm\_page\_type
      "+main", "+problem+", or "+view+".


\end{itemlist}
\end{indpar}

For session variables just read by index.php, see other
EPM pages.

\subsubsection{Index Page Transactions}

See Page Initialization \sref{PAGE-INITIALIZATION}{INDEX-ACTIONS}.

\newpage

\subsection{Login Page}

\begin{center}
{\bf Login Page Requires}
\\[1ex]
\begin{tabular}{l}
\TT{page/index.php} \\
\TT{include/epm\_random.php} \\
\end{tabular}
\\[3ex]
{\bf Login Page Files}
\\[1ex]
\begin{tabular}{lllll}
\TT{admin/+blocking+}		& -	  & -      & read \\
\TT{admin/motd.html}		& -	  & -      & read \\
\TT{admin/+lock+}		& create  & update & read \\
\TT{admin/+random+}		& create  & update & read
\\[2ex]
\TT{admin/browser/TICKET}	& create  & -      & read \\
\TT{admin/email/EMAIL}		& -       & update & read \\
\TT{admin/users/UID/UID.login}	& -       & append & stat \\
\TT{admin/users/UID/GID.login}	& -       & append & stat \\
\TT{admin/teams/TID/MID.login}	& -       & append & stat \\
\end{tabular}
\\[3ex]
{\bf Login Page Session Data}
\\[1ex]
\begin{tabular}{lllll}
\TT{EPM\_EMAIL}	& create  & -      & - \\
\TT{EPM\_AID}	& create  & -      & read    \\
\TT{EPM\_UID}	& create  & -      & -    \\
\TT{EPM\_IS\_TEAM}
		& create  & -      & -    \\
\TT{EPM\_IPADDR}& create  & -      & read \\
\TT{EPM\_TIME}
                & create  & -      & read \\
\TT{EPM\_ABORT}
                & create  & -      & - \\
\end{tabular}
\end{center}

\subsubsection{Login Page File Formats}

\begin{indpar}
\begin{itemlist}
\item[\TT{admin/+blocking+}:]~
\label{ADMIN/BLOCKING} \\
Lines of format:\hspace{0.5in}SIGN RE \\
\begin{tabular}[t]{@{\hspace{0.2in}}lp{3.9in}}
SIGN & {\tt +} to not block, {\tt -} to block \\
RE & regular expression matched to the entire email name
     (e.g., {\tt .*} matches any email name and
     {\tt .*\textbackslash.edu} matches any email
     name ending in {\tt .edu})
\end{tabular}
\\
\begin{itemize}
\item The lines are read in order and the first line
with RE matching the login name EMAIL is used to
not block or block the EMAIL.  If no line matches,
the EMAIL is \underline{not} blocked.
\item Blank lines and whose first non-whitespace
character is {\tt \#} are ignored.  Various forms
of within-line whitespace are equivalent, and
whitespace at beginning or end of a line is ignored.
\end{itemize}

\item[\TT{admin/motd.html}:]~
\label{ADMIN/MOTD} \\
An HTML file that is included inside a {\tt <div>\ldots</div>}
block that gives the `message of the day' on the Login Page.  Typically
this file consists of some {\tt <p>} paragraphs.
If the file does not exist, the {\tt <div>\ldots</div>}
block is not created.

\item[\TT{admin/+lock+}:]~
\label{ADMIN/LOCK} \\
All transactions within the {\tt admin} directory
(i.e., all http requests that access files or subdirectories
within {\tt admin})
begin by calling the {\tt parameters.php} {\tt LOCK}
function to lock the {\tt admin} directory.  This function locks the
directory by creating if necessary and locking this {\tt +lock+} file
for the course of the transaction.  Note there are \underline{no}
EPM transactions longer than a single http request.

\item[\TT{admin/+random+}:]~
\label{ADMIN/RANDOM} \\
The pseudo-random number generator in {\tt include/\EOL
epm\_random.php} exclusively creates, updates, an reads this file.

\item[\TT{admin/browser/TICKET} (ticket file):] T AID EMAIL
\label{ADMIN/TICKET/TICKET} \\
\begin{tabular}[t]{lp{4.0in}}
TICKET & ticket proper; 32 hexadecimal digit ticket number \\
T & ticket type; `c' for confirmation number; `a' for automatic \\
AID & account ID: \\
    & ~~~ team ID (TID) if ticket is for team member login \\
    & ~~~ user ID (UID) if ticket is for guest login \\
    & ~~~ '-' if ticket is for user login \\
EMAIL & Email address (identifying user account) \\
\end{tabular}
\\
\begin{itemize}
\item When a user initially logs in to create an account,
the UID is not known when the ticket is created.
\end{itemize}

\item[\TT{admin/email/EMAIL} (regular email file):] UID ACOUNT ATIME
\label{ADMIN/EMAIL/EMAIL} \\
\begin{tabular}[t]{lp{4.0in}}
EMAIL & Email address encoded with PHP rawurlencode \\
UID & user ID \\
ACOUNT & Number of auto-login periods completed so far. \\
ATIME & Start time of newest (incomplete) auto-login period. \\
\end{tabular}

\item[\TT{admin/email/EMAIL} (pre-login email file):] - TID ...
\label{ADMIN/EMAIL/EMAIL-PRE-LOGIN} \\
\begin{tabular}[t]{lp{4.0in}}
EMAIL & Email address encoded with PHP rawurlencode \\
TID & Team user ID (may be more than one) \\
\end{tabular}
\\
\begin{itemize}
\item This form of email file is created by the User Page when
a team member is assigned the given EMAIL before the member
has an account or EMAIL has been added to an existing account.
The TID's list \underline{all} the team IDs that
\underline{might} in their {\tt TID.info} file
have a member which has this EMAIL and no UID.
A TID might be listed whose
{\tt TID.info} file no longer contains the EMAIL.
\\[1ex]
When the pre-login form is converted to a regular form,
the list of TID's is used to convert any matching EMAIL members
in {\tt TID.info} files to UID(EMAIL) members.
\end{itemize}

\item[\TT{admin/users/UID/UID.login} (login log):]
\item[\TT{admin/teams/TID/UID.login} (login log):]\vspace*{-1ex}
\item[\TT{admin/users/UID/GID.login} (login log):]\vspace*{-1ex}~
\label{ADMIN/USERS/XID/YID.LOGIN} \\
Lines of format:\hspace{0.5in}TIME EMAIL IPADDR BROWSER \\
\begin{tabular}[t]{@{\hspace{0.2in}}lp{3.9in}}
UID & User ID \\
TID & Team ID \\
GID & Guest User ID \\
TIME & Session time for login (EPM\_TIME) \\
EMAIL & Email address used for login (EPM\_EMAIL) \\
IPADDR & IP address for session (EPM\_IPADDR) \\
BROWSER & \STACK{
          \$\_SERVER['HTTP\_USER\_AGENT'] with `(...)'s\\
	  removed and horizontal spaces replaced by `\TT{;}'s} \\
\end{tabular}
\\
\begin{itemize}
\item
A login with name AID:EMAIL is valid iff the file
{\tt .../AID/UID.login} exists for UID the user ID associated
with EMAIL.
\item Upon login, a line is appended to the appropriate
the {\tt .login} file, and then that file's name and modification
time are stored in EPM\_ABORT and used to abort a session if another session
logs in with the same AID:EMAIL and appends to the file, thus
changing its modification time.
\end{itemize}


\end{itemlist}
\end{indpar}

\subsubsection{Login Page Session Variables}

\begin{indpar}[0.2in]
\begin{tabular}[t]{lp{4.5in}}
\TT{EPM\_EMAIL}\label{EPM_EMAIL}
    & EMAIL entered by user into browser; set by Login Page when either
      (1) EMAIL is to be transferred to user.php for a new user,
      or (2) browser sends TICKET which identifies
      EMAIL and EPM\_UID is being set.
\\[0.5ex]
\TT{EPM\_AID}\label{EPM_AID}
    & Account ID, either user or team; set by Login Page when a valid
      TICKET is received, and set by User Page for new users.
      This equals EPM\_UID for a user login, is the team ID for
      team member login, and is the host user ID of the EMAIL guest for
      a guest login. 
\\[0.5ex]
\TT{EPM\_UID}\label{EPM_UID}
    & User ID associated with EPM\_EMAIL.
      Set when EPM\_\EOL AID is set.
\\[0.5ex]
\TT{EPM\_IS\_TEAM}\label{EPM_IS_TEAM}
    & True iff EPM\_AID is team ID;
      Set when EPM\_AID is set.
\\[0.5ex]
\TT{EPM\_IPADDR}\label{EPM_IPADDR}
    & Set to \$\_SERVER['REMOTE\_ADDR'] by Login Page when EPM\_\EOL AID is
      not yet set.
\\[0.5ex]
\TT{EPM\_TIME}\label{EPM_TIME}
    & Set to \$\_SERVER['REQUEST\_TIME'] formatted by \$epm\_\EOL format\_time
      by Login Page if EPM\_AID is not yet set.
\\[0.5ex]
\TT{EPM\_ABORT}\label{EPM_ABORT}
    & Set to [FILE,MTIME] where MTIME is the mod time of \$epm\_data/FILE
      and the session must abort if the mod time of this file changes.
      Here FILE is admin/users/AID/UID.login to which a line is appended
      whenever EPM\_AID is set for a session.
\end{tabular}
\end{indpar}


\subsubsection{Login Page Transactions}

\begin{enumerate}
\item If regular form admin/emails/EMAIL exists
      log existing user in and go to Project Page.  The browser
      first gets a ticket which it sends to the server, and
      the ticket specifies the EMAIL.
\begin{enumerate}
\item Browser can look EMAIL up in browser's local memory to get
      ticket to send to server, or if this ticket does not exist
      or is invalid,
\item Browser can send EMAIL to server and get confirmation number back to use
      as a ticket.
\end{enumerate}
\item Otherwise, if no regular form admin/emails/EMAIL exists, give
      the browser a confirmation number to use as ticket, and upon
      receiving this set EPM\_EMAIL and give the browser a new
      automatic ticket and instruct the browser to
      go to User Page to create new user.
\end{enumerate}

\newpage

\subsection{User Page}

\begin{center}
{\bf User Page Files}
\\[1ex]
\begin{tabular}{lllll}
\TT{admin/email/EMAIL}	& create  & update & read \\
\TT{admin/users/UID/UID.info}
			& create  & update & read \\
\TT{admin/teams/TID/TID.info}
			& create  & update & read \\
\TT{admin/users/UID/UID.login}
			& -       & append & stat \\
\TT{admin/users/UID/GID.login}
			& -       & append & stat \\
\TT{admin/teams/TID/UID.login}
			& -       & append & stat \\
\TT{admin/users/UID/UID.inactive}
			& create  & -      & - \\
\TT{admin/users/UID/GID.inactive}
			& create  & -      & - \\
\TT{admin/teams/TID/UID.inactive}
			& create  & -      & - \\
\TT{admin/users/UID/manager}
			& create  & update & read \\
\TT{admin/users/UID/member}
			& create  & update & read \\
\TT{admin/teams/TID/+rw+}
			& create  & update & read \\
\TT{admin/users/UID/+actions+}
			& create  & append & - \\
\TT{admin/teams/TID/+actions+}
			& create  & append & - \\
\TT{admin/+actions+}
			& create  & append & - \\
\end{tabular}
\\[3ex]
{\bf User Page Session Data}
\\[1ex]
\begin{tabular}{llll}
\TT{EPM\_USER}	& create  & update & read \\
\TT{EPM\_DATA}	& create  & update & read \\
\TT{EPM\_EMAIL}	& -       & -      & read \\
\TT{EPM\_AID}	& create  & -      & read \\
\TT{EPM\_UID}	& create  & -      & read \\
\TT{EPM\_IS\_TEAM}
                & create  & -      & read \\
\TT{EPM\_IPADDR}& -       & -      & read \\
\TT{EPM\_TIME}  & -       & -      & read \\
\TT{EPM\_ABORT} & create  & -      & - \\
\end{tabular}
\end{center}

\subsubsection{User Page File Formats}

\begin{indpar}
\begin{itemlist}
\item[\TT{admin/email/EMAIL}:] see \pagref{ADMIN/EMAIL/EMAIL} 
\item[\TT{admin/users/UID/UID.info} (user info file):]~
\label{ADMIN/USERS/UID/UID.INFO} \\
JSON file with the following components:
\begin{tabular}[t]{ll}
\TT{'uid'} & UID \\
\TT{'emails'} & \TT{[} EMAIL \{ \TT{,} EMAIL \}\STAR{} \TT{]} \\
\TT{'guests'} & \TT{[} GID \{ \TT{,} GID \}\STAR{} \TT{]}
                (may be missing) \\
\TT{'full\_name'} & TEXT \\
\TT{'organization'} & TEXT \\
\TT{'location'} & TEXT \\
\end{tabular}
\\
where
\\
\begin{tabular}[t]{lp{4.0in}}
UID & user ID (i.e., an account ID) for user; cannot be changed once
      account is created \\
EMAIL & e-mail address for user \\
GID & UID for guest of user \\
TEXT & plain text (with a minimum and maximum allowed length) \\
\end{tabular}
\\
\begin{itemize}
\item When a team UID.info file is created, MIDs are specified
as EMAILs which are resolved if possible to PIDs.
\item When a person initially creates an account, all
UID.info files are searched and if any have MIDs matching
the new account EMAIL, they are resolved to PIDs.
\end{itemize}

\item[\TT{admin/users/TID/TID.info} (user info file):]~
\label{ADMIN/USERS/TID/TID.INFO} \\
JSON file with the following components:
\begin{tabular}[t]{ll}
\TT{'tid'} & TID \\
\TT{'manager'} & MANAGER \\
\TT{'members'} & \TT{[} MEMBER \{ \TT{,} MEMBER \}\STAR{} \TT{]}
                (may be missing) \\
\TT{'full\_name'} & TEXT \\
\TT{'organization'} & TEXT \\
\TT{'location'} & TEXT \\
\end{tabular}
\\
where
\\
\begin{tabular}[t]{lp{4.0in}}
TID & team ID (i.e., an account ID) for team; cannot be changed once
      account is created \\
MANAGER & UID of the manager of team \\
MEMBER & one of: \begin{tabular}[t]{l}
                 MID \\
		 (EMAIL) \\
		 MID(EMAIL) \\
		 \end{tabular} \\
MID & UID of member of team \\
EMAIL & EMAIL of member of team as of time member was added to team  \\
TEXT & plain text (with a minimum and maximum allowed length) \\
\end{tabular}
\\
\begin{itemize}
\item A MEMBER may be specified as an EMAIL or a MID.
If specified as an EMAIL, and a regular {\tt admin/email/EMAIL}
(\pagref{ADMIN/EMAIL/EMAIL}) exists,
the MID is added.  If specified as an EMAIL, and no
regular {\tt admin/email/EMAIL} file exists, the TID is added to
a pre-login {\tt admin/email/EMAIL} (\pagref{ADMIN/EMAIL/EMAIL-PRE-LOGIN}),
which is created if it does not exist.
\item When a user initially creates an account with an EMAIL for which
a pre-login {\tt admin/email/EMAIL} file exists, the TID.info files
for all TIDs listed in the pre-login file are searched for any MEMBERs
of the form `(EMAIL)', and when one is found, its MID is added to it.
Similarly if EMAIL is added to an existing user account.
\end{itemize}

\item[\TT{admin/users/UID/UID.login} (login log):]
\item[\TT{admin/teams/TID/UID.login} (login log):]\vspace*{-1ex}
\item[\TT{admin/users/UID/GID.login} (login log):]\vspace*{-1ex}
see \pagref{ADMIN/USERS/XID/YID.LOGIN}

\item[\TT{admin/teams/TID/UID.inactive}:]
\item[\TT{admin/users/UID/GID.inactive}:]\vspace*{-1ex} ~
\label{ADMIN/USERS/XID/YID.INACTIVE} \\
Inactive {\tt .login} file, made by renaming {\tt .login} file
when UID is no longer a member of TID team or GID is no longer
a guest of UID.  May be reactivated by renaming to {\tt .login}
file.

\item[\TT{admin/users/UID/manager}:] ~
\label{ADMIN/USERS/UID/MANAGER} \\
A a list of single space separated TIDs of the teams of which
user UID is a manager.

\item[\TT{admin/users/UID/member}:] ~
\label{ADMIN/USERS/UID/MEMBER} \\
A a list of single space separated TIDs of the teams of which
user UID is a member.

\item[\TT{admin/teams/TID/+rw+}:] ~
\label{ADMIN/TEAMS/TID/RW} \\
Either a single UID of the team member whose login currently
has read-write mode, or blank if no such.  This file is locked
by itself for exclusive use by team member login requests,
and this is independent of any {\tt +lock+} file locking.
The lock is released immediately for read-only requests, but
is held to the end of read-write requests.


\item[\TT{admin/users/UID/+actions+}:]
\item[\TT{admin/teams/TID/+actions+}:]\vspace*{-1ex} ~
\label{ADMIN/XXXX/XID/ACTIONS} \\
Lines of format:\hspace{0.5in}TIME AID info KEY OP VALUE \\
\begin{tabular}[t]{@{\hspace{0.2in}}lp{3.9in}}
TIME & Session time for login (EPM\_TIME) \\
AID & equals UID or TID from file name \\
KEY & {\tt .info} file JSON key \\
OP & {\tt =} if non-list KEY reset, {\tt +} if addition to KEY's list,
     {\tt -} if deletion from KEY's list \\
VALUE & value given to non-list KEY, added to KEY's list,
        or deleted from KEY's list \\
\end{tabular}
\\
\begin{itemize}
\item Updates to {\tt AID.info} file are logged by writting lines
to {\tt admin/*/AID/+actions+} file.
\end{itemize}

\item[\TT{admin/+actions+}:] ~
\label{ADMIN/ACTIONS} \\
Any line writted to an {\tt admin/*/AID/+actions+} file is
also written to this file.

\end{itemlist}
\end{indpar}

\subsubsection{User Page Transactions}

\begin{enumerate}
\item If EPM\_UID not set, get data for new user and create
      new user account if data acceptable.  Otherwise, or
      after creating new user account, display {\tt .info}
      data for all users and all teams.
\item Allow the current user to edit their own {\tt .info} data.
\item If the current user is the manager of a team, allow that
      team's {\tt .info} data to be edited.
\item Allow the current user to create a new team of which the
      current user is a manager.
\item NOTE: team member and guest logins cannot edit user or
      team {\tt .info} or create new teams.
\item Allow a current read-only user to force a switch to read-write.
\end{enumerate}

\newpage

\subsection{Problem Page}

\begin{center}
{\bf Problem Page Visible Files}
\\[1ex]
\begin{tabular}{lllll}
\TT{accounts/AID/PROBLEM}	        & create  & update & read & delete
\\[0.5ex]
\TT{accounts/AID/PROBLEM/PROBLEM.tex}	& upload  & -      & read & delete \\
\TT{accounts/AID/PROBLEM/PROBLEM.pdf}	& create  & -      & read & delete
\\[0.5ex]
\TT{accounts/AID/PROBLEM/PROBLEM.c}	& upload  & -      & read & delete \\
\TT{accounts/AID/PROBLEM/PROBLEM.cc}	& upload  & -      & read & delete \\
\TT{accounts/AID/PROBLEM/PROBLEM.java}	& upload  & -      & read & delete \\
\TT{accounts/AID/PROBLEM/PROBLEM.py}	& upload  & -      & read & delete \\
\TT{accounts/AID/PROBLEM/PROBLEM}	& create  & -      & read & delete \\
\TT{accounts/AID/PROBLEM/PROBLEM.jar}	& create  & -      & read & delete \\
\TT{accounts/AID/PROBLEM/PROBLEM.pyc}	& create  & -      & read & delete
\\[0.5ex]
\TT{accounts/AID/PROBLEM/YYYY-PROBLEM.c} & upload  & -     & read & delete \\
\TT{accounts/AID/PROBLEM/YYYY-PROBLEM.cc} & upload  & -    & read & delete \\
\TT{accounts/AID/PROBLEM/YYYY-PROBLEM.java} & upload  & -  & read & delete \\
\TT{accounts/AID/PROBLEM/YYYY-PROBLEM.py} & upload & -     & read & delete \\
\TT{accounts/AID/PROBLEM/YYYY-PROBLEM}	& create  & -      & read & delete \\
\TT{accounts/AID/PROBLEM/YYYY-PROBLEM.jar} & create  & -   & read & delete \\
\TT{accounts/AID/PROBLEM/YYYY-PROBLEM.pyc} & create  & -   & read & delete
\\[0.5ex]
\TT{accounts/AID/PROBLEM/XXXX-PROBLEM.in} & upload  & -    & read & delete \\
\TT{accounts/AID/PROBLEM/XXXX-PROBLEM.sin} & create  & -   & read & delete \\
\TT{accounts/AID/PROBLEM/XXXX-PROBLEM.sout} & create  & -  & read & delete \\
\TT{accounts/AID/PROBLEM/XXXX-PROBLEM.fout} & create  & -  & read & delete \\
\TT{accounts/AID/PROBLEM/XXXX-PROBLEM.ftest} & create  & - & read & delete \\
\TT{accounts/AID/PROBLEM/XXXX-PROBLEM.dout} & create  & -  & read & delete \\
\TT{accounts/AID/PROBLEM/XXXX-PROBLEM.score} & create  & - & read & delete \\
\\[0.5ex]
\TT{accounts/AID/PROBLEM/ZZZZ-PROBLEM.run} 	  & -  & - & read & -
\end{tabular}
\\[1ex]
Special values for YYYY: \TT{generate}, \TT{filter}, \TT{monitor}, \TT{display}
\\\bigskip
{\bf Problem Page Parent Files}
\\[1ex]
\begin{tabular}{lllll}
\TT{projects/PROJECT/PROBLEM}	        	& -  & - & read & - \\
\TT{projects/PROJECT/PROBLEM/PROBLEM.pdf}    	& -  & - & read & - \\
\TT{projects/PROJECT/PROBLEM/PROBLEM.optn}    	& -  & - & read & - \\
\TT{projects/PROJECT/PROBLEM/generate-PROBLEM} 	& -  & - & read & - \\
\TT{projects/PROJECT/PROBLEM/filter-PROBLEM} 	& -  & - & read & - \\
\TT{projects/PROJECT/PROBLEM/display-PROBLEM} 	& -  & - & read & - \\
\TT{projects/PROJECT/PROBLEM/monitor-PROBLEM} 	& -  & - & read & - \\
\TT{projects/PROJECT/PROBLEM/XXXX-PROBLEM.in}	& -  & - & read & - \\
\TT{projects/PROJECT/PROBLEM/XXXX-PROBLEM.ftest} & -  & - & read & - \\
\TT{projects/PROJECT/PROBLEM/ZZZZ-PROBLEM.run} & -  & - & read & -
\\[1ex]
\end{tabular}
\\\bigskip
{\bf Problem Page Maintenance Files}
\\[1ex]
\begin{tabular}{lllll}
\TT{accounts/AID/PROBLEM/+parent+}		& -  & - & read & delete \\
\TT{accounts/AID/PROBLEM/PROBLEM.optn}		& -  & - & read & delete
\\[1ex]
\end{tabular}
\\[3ex]
{\bf Problem Page Session Data}
\\[1ex]
\begin{tabular}{lllll}
\TT{EPM\_EMAIL}	& -       & -      & read \\
\TT{EPM\_UID}	& -       & -      & read \\
\TT{EPM\_PROBLEM}
		& create  & update & read \\
\end{tabular}
\end{center}

\end{document}
